<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Packs Widget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="./style.css" />

  <style>
    /* keep the iframe/page from side-scrolling */
    html, body { overflow-x: hidden; }
  </style>

  <!-- Supabase SDK (must load before we create a client) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Supabase project config: set URL & anon key on window -->
  <script>
    // These are safe to expose on the client.
    window.__SUPABASE_URL = 'https://srdwkfjterotzjwzoauj.supabase.co';
    window.__SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ';
  </script>

  
  <!-- Backend base (define BEFORE app.js so app.js can read it) -->
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      let apiBase = params.get('api') || 'https://backend-o9ot.onrender.com';
      apiBase = String(apiBase || '').trim()
        .replace(/\/+$/, '')
        .replace(/\/api$/i, '');
      window.__PACKS_API_BASE = apiBase; // e.g. "https://backend-o9ot.onrender.com"
    })();
  </script>

  <!-- Create ONE global Supabase client everyone can reuse -->
  <script>
    if (!window.supabase) {
      console.error('Supabase CDN failed to load');
    } else {
      window.supa = window.supabase.createClient(
        window.__SUPABASE_URL,
        window.__SUPABASE_ANON_KEY
      );
    }
  </script>

  <!-- Handle magic-link returns (hash with access_token), then clean URL -->
  <script>
  (async function () {
    try {
      if (window.supa && location.hash && location.hash.includes('access_token')) {
        console.log('[supabase] Processing magic link hash...');
        
        const params = new URLSearchParams(location.hash.slice(1));
        const access_token = params.get('access_token');
        const refresh_token = params.get('refresh_token');
        const error = params.get('error');
        const error_description = params.get('error_description');

        // Check for errors first
        if (error) {
          console.error('[supabase] Auth error:', error, error_description);
          alert(`Authentication error: ${error_description || error}`);
          history.replaceState({}, '', location.pathname + location.search);
          return;
        }

        if (access_token && refresh_token) {
          console.log('[supabase] Setting session from magic link...');
          const { data, error } = await window.supa.auth.setSession({
            access_token,
            refresh_token
          });
          
          if (error) {
            console.error('[supabase] setSession error:', error);
            alert(`Session error: ${error.message}`);
          } else {
            console.log('[supabase] Session set successfully:', data);
            // Optionally reload the app or update UI
            window.location.reload();
          }
        }

        // Clean URL regardless of success/failure
        history.replaceState({}, '', location.pathname + location.search);
      }
    } catch (e) {
      console.error('[supabase] Magic link processing failed:', e);
    }
  })();
  </script>
</head>


<body>
  <!-- Simple auth UI (must be in BODY, after client is created) -->
  

  <!-- Widget UI -->
  <div id="app" class="widget" aria-live="polite">
    <div class="topbar">
      <div class="meta">
        <div class="balance" id="balance">Balance: —</div>
        <div class="price"   id="price">Price: —</div>
      </div>
    </div>

    <div class="stage">
      <div class="anchor">
        <img class="pack-img" src="./assets/pack.png" alt="Pack" id="packImg" />
        <div class="stack" id="stack" hidden></div>
        <div class="tray"  id="tray"  hidden></div>

        <!-- overlay lives INSIDE the stage so it appears on top (not below) -->
        <div id="overlay" class="overlay" hidden>
          <div class="overlay-backdrop"></div>
          <div class="overlay-card">
            <img id="overlay-img" alt="" />
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="cta" class="btn">Open Packs</button>
    </div>

    <div id="error" class="error" hidden></div>
  </div>
  
 

  <!-- Your app (module so we can use top-level await); after client + auth UI -->
  <script type="module" src="./app.js"></script>

  <!-- Resize notifier for parent iframe (optional) -->
  <script>
    (function () {
      function postHeight(){
        const h = Math.max(
          document.documentElement.scrollHeight,
          document.body?.scrollHeight || 0
        );
        if (window.parent && window.parent !== window){
          window.parent.postMessage({ type:'packs:height', height:h }, '*');
        }
      }
      window.addEventListener('load', postHeight);
      window.addEventListener('resize', postHeight);
      const mo = new MutationObserver(postHeight);
      mo.observe(document.documentElement, { childList:true, subtree:true, attributes:true });

      // respond to parent “probe”
      window.addEventListener('message', (e) => {
        if ((e.data || {}).type === 'packs:probe') postHeight();
      });

      postHeight();
    })();
  </script>
  <script>
  // iOS Safari fires "gesture*" events for pinch — block them
  document.addEventListener('gesturestart',  e => e.preventDefault(), { passive: false });
  document.addEventListener('gesturechange', e => e.preventDefault(), { passive: false });
  document.addEventListener('gestureend',    e => e.preventDefault(), { passive: false });

  // Block multi-touch zoom attempts (two+ fingers)
  document.addEventListener('touchstart', function (e) {
    if (e.touches && e.touches.length > 1) e.preventDefault();
  }, { passive: false });

  // Some iOS versions expose e.scale during pinch — block when not neutral
  document.addEventListener('touchmove', function (e) {
    if (typeof e.scale === 'number' && e.scale !== 1) e.preventDefault();
  }, { passive: false });

  // Stop double-tap-to-zoom without breaking single taps
  (function () {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (e) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        e.preventDefault(); // suppress second tap zoom
      }
      lastTouchEnd = now;
    }, { passive: false });
  })();
  </script>

</body>
</html>
