<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>3D Music Inventory - Beta2</title>
   

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // Safe to expose in client
      window.__SUPABASE_URL = 'https://srdwkfjterotzjwzoauj.supabase.co';
      window.__SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ';
    </script>
    <script>
      window.supa = window.supabase.createClient(
        window.__SUPABASE_URL,
        window.__SUPABASE_ANON_KEY
      );
    </script>
    <script>
      (async function () {
        try {
          if (window.supa && location.hash && location.hash.includes('access_token')) {
            const params = new URLSearchParams(location.hash.slice(1));
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            const error = params.get('error');
            const error_description = params.get('error_description');
            if (error) {
              alert(`Authentication error: ${error_description || error}`);
              history.replaceState({}, '', location.pathname + location.search);
              return;
            }
            if (access_token && refresh_token) {
              const { error } = await window.supa.auth.setSession({ access_token, refresh_token });
              if (error) alert(`Session error: ${error.message}`); else window.location.reload();
            }
            history.replaceState({}, '', location.pathname + location.search);
          }
        } catch (e) { console.error('[supabase] Magic link processing failed:', e); }
      })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            font-weight: 400;
            line-height: 1.5;
        }

        .main-container {
            display: grid;
            grid-template-columns: minmax(320px, 1fr) 1fr;
            height: 100vh;
            gap: 0;
        }

        .inventory-panel {
            padding: 32px;
            background: #0a0a0a;
            border-right: 1px solid #1a1a1a;
            height: 100vh;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
        }

        .inventory-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 12px;
        }

        .inventory-content::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .viewport-panel {
            background: #111111;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }

        .menu-button, .login-button {
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color .2s ease, background .2s ease;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .menu-button:hover, .login-button:hover {
            border-color: rgba(255, 255, 255, 0.45);
        }

        .menu-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 3px;
            height: 3px;
            background: #fff;
            border-radius: 50%;
        }

        .user-icon {
            width: 16px;
            height: 16px;
            color: #fff;
        }

        .user-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .menu-tray {
            position: fixed;
            top: 60px;
            left: 20px;
            width: 130px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            z-index: 999;
            transform: translateY(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all .3s ease;
            padding: 10px 0;
        }

        .menu-tray.open {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .menu-item {
            position: relative;
            display: block;
            width: 100%;
            padding: 6px 15px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            background: none;
            border: 0;
        }

        .menu-item::before {
            content: "";
            position: absolute;
            inset: 1px;
            left: 8px;
            right: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.12);
            opacity: 0;
            transform: scaleY(0.96);
            transition: opacity .15s ease, transform .2s ease;
            pointer-events: none;
        }

        .menu-item:hover::before, .menu-item:focus-visible::before {
            opacity: 1;
            transform: scaleY(1);
        }

        .menu-item, .menu-item * {
            position: relative;
            z-index: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: block;
        }
        
        .modal-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(0,0,0,0.45); /* dims behind */
          pointer-events: auto;         /* captures clicks so page behind isn't clickable */
        }

        .login-modal {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            color: #fff;
        }

        .modal-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .modal-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 16px;
            padding: 8px 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all .2s ease;
        }

        .modal-tab.active {
            color: #fff;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-button {
            width: 100%;
            background: rgba(255,255,255,0.92);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #1a1a1a;
            padding: 12px 20px;
            z-index: 1000;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            color: #666666;
            touch-action: manipulation;
        }

        .nav-item.active {
            color: #ffffff;
        }

        .nav-icon {
            font-size: 18px;
            color: inherit;
            font-weight: normal;
        }

        .desktop-nav {
            display: flex;
            gap: 2px;
            margin-bottom: 0;
            background: #111111;
            border-radius: 8px 8px 0 0;
            border-top: 1px solid #1a1a1a;
            padding: 4px;
            margin-top: 12px;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }

        .nav-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #666666;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            text-align: center;
            touch-action: manipulation;
        }

        .nav-tab:hover {
            color: #ffffff;
        }

        .nav-tab.active {
            background: #1a1a1a;
            color: #ffffff;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .viewport-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            height: 100%;
            width: 100%;
            min-width: 0;
        }

        .viewport-panel canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        .viewport-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .item-info-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(40px);
            padding: 24px;
            border-top: 1px solid #1a1a1a;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        .item-info-panel.visible {
            transform: translateY(0);
        }

        .item-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .item-description {
            color: #cccccc;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .item-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        /* 1) Lock the card height to your original size */
        .character-card.fixed{
          /* let the image row actually take the available height */
          grid-template-rows: minmax(0,1fr) auto auto;
        }

        .character-media{
          position: relative;
          display: grid;
          place-items: center;
          overflow: hidden;
          /* optional if you want a square window */
          /* aspect-ratio: 1 / 1; */
          min-height: 0; /* prevents grid min-content overflow */
        }

        .character-media img{
          width: 100%;
          height: 100%;
          object-fit: cover;   /* use 'contain' if you don’t want cropping */
          display: block;
        }

        /* 4) Keep titles tidy so they don't steal space from the image */
        .character-name{
          margin: 0;
          line-height: 1.15;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .character-status{
          margin: 0;
          opacity: 0.8;
          font-size: 0.9rem;
        }

        /* Optional: responsive tweak so cards stay consistent on mobile */
        @media (max-width: 640px){
          .character-card.fixed{ --card-h: 180px; }
        }

        .character-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .character-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .character-card.locked {
            opacity: 0.5;
        }

        .character-card.locked::after {
            content: '🔒';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 14px;
        }

        .character-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a1a1a;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .character-avatar-img{
          width:100%;
          aspect-ratio:1/1;
          object-fit:cover;
          border-radius:3px; /* or 50% if you want it round like now */
          background:#1a1a1a;
          display:block;
        }

        .character-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .character-card p {
            font-size: 13px;
            color: #888888;
            margin-bottom: 8px;
        }

        .character-card small {
            font-size: 12px;
            color: #666666;
        }

        .collection-section {
            display: grid;
            gap: 24px;
        }

        .collection-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
        }

        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 16px;
            cursor: pointer;
            user-select: none;
        }

        .collection-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .collection-info p {
            font-size: 14px;
            color: #888888;
        }

        .collection-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .progress-bar {
            width: 80px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #ffffff;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .progress-text {
            font-size: 13px;
            color: #888888;
            font-weight: 500;
        }

        .items-grid {
            display: grid;
            gap: 12px;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            max-height: 9999px;
            opacity: 1;
            transition: max-height .35s ease, opacity .25s ease, margin .25s ease, padding .25s ease;
        }

        .items-grid::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .item-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .item-card:hover {
            border-color: #333333;
            background: #111111;
        }

        .item-card.completed {
            border-color: #333333;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .item-completion {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #888888;
        }

        .item-completion.complete {
            background: #ffffff;
            color: #0a0a0a;
        }

        .stems-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .stem-slot, .fragment-slot {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #333333;
            transition: all 0.2s ease;
            cursor: pointer;
            background: #1a1a1a;
            color: #666666;
        }

        .stem-slot.collected, .fragment-slot.collected {
            background: #ffffff;
            border-color: #ffffff;
            color: #0a0a0a;
        }

        .stem-slot.collected:hover, .fragment-slot.collected:hover {
            transform: scale(1.05);
        }

        .stem-slot.empty, .fragment-slot.empty {
            background: #0a0a0a;
            cursor: not-allowed;
            border-color: #1a1a1a;
        }

        .unlock-progress {
            margin-top: 16px;
            padding: 16px;
            background: #0a0a0a;
            border-radius: 8px;
            border: 1px solid #1a1a1a;
            font-size: 13px;
            color: #cccccc;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            max-height: 9999px;
            opacity: 1;
            transition: max-height .35s ease, opacity .25s ease, margin .25s ease, padding .25s ease;
        }

        .unlock-progress::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .unlock-progress.ready {
            border-color: #333333;
            background: #111111;
        }

        .collection-card.collapsed .items-grid,
        .collection-card.collapsed .unlock-progress {
            max-height: 0;
            opacity: 0;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        .collection-header .collapse-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff;
            font-size: 12px;
            line-height: 1;
            transition: transform .2s ease, background .2s ease, border-color .2s ease;
        }

        .collection-header .collapse-toggle:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.2);
        }

        .collection-card.collapsed .collapse-toggle {
            transform: rotate(-90deg);
        }

        .unreleased-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .unreleased-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .unreleased-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
        }

        .rarity-tag {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rarity-common { background: #333333; color: #ffffff; }
        .rarity-rare { background: #ffffff; color: #0a0a0a; }
        .rarity-epic { background: #ffffff; color: #0a0a0a; }
        .rarity-legendary { background: #ffffff; color: #0a0a0a; }

        .unreleased-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            padding-right: 60px;
        }

        .unreleased-card p {
            font-size: 13px;
            color: #888888;
            line-height: 1.5;
        }

        input, textarea, select {
            font-size: 16px;
        }

        button, a, .menu-button, .login-button, .nav-item, .nav-tab {
            touch-action: manipulation;
        }

        #stems .collection-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        #stems .collection-card {
            padding: 16px;
            cursor: pointer;
            transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
        }

        #stems .collection-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
        }

        #stems .collection-card .items-grid,
        #stems .collection-card .unlock-progress {
            display: none !important;
        }

        #stems .collection-card .collection-header {
            margin-bottom: 0;
            align-items: center;
        }

        #stems .collection-card .collection-info h3 {
            font-size: 16px;
        }

        #stems .collection-card .collection-info p {
            font-size: 12px;
            color: #9a9a9a;
        }

        #stems .collection-card .progress-bar {
            width: 72px;
        }

        #fragments .collection-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        #fragments .collection-card {
            padding: 16px;
            cursor: pointer;
            transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
        }

        #fragments .collection-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
        }

        #fragments .collection-card .items-grid,
        #fragments .collection-card .unlock-progress {
            display: none !important;
        }

        #fragments .collection-card .collection-header {
            margin-bottom: 0;
            align-items: center;
        }

        #fragments .collection-card .collection-info h3 {
            font-size: 16px;
        }

        #fragments .collection-card .collection-info p {
            font-size: 12px;
            color: #9a9a9a;
        }

        #fragments .collection-card .progress-bar {
            width: 72px;
        }

        .album-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            display: block;
            z-index: 2000;
            pointer-events: none;
            padding: var(--album-pad-top, 24px) var(--album-pad-right, 24px) 24px var(--album-pad-left, 24px);
        }

        .album-overlay .album-sheet {
            display: none;
        }

        .album-overlay.show .album-sheet {
            display: grid;
        }

        .album-sheet {
            pointer-events: auto;
            width: 100%;
            height: calc(100dvh - var(--album-pad-top, 24px) - 24px);
            max-height: calc(100dvh - var(--album-pad-top, 24px) - 24px);
            background: #0b0b0b;
            border: 1px solid #1a1a1a;
            border-radius: 14px;
            overflow: hidden;
            grid-template-rows: auto 1fr;
            box-shadow: 0 20px 60px rgba(0,0,0,.45);
            min-width: 360px;
        }

        .album-sheet .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 18px;
            border-bottom: 1px solid #1a1a1a;
            background: linear-gradient(180deg,#0f0f0f,#0a0a0a);
        }

        .sheet-meta {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sheet-title h3 {
            font-size: 18px;
            margin: 0;
        }

        .sheet-title p {
            font-size: 13px;
            color: #9a9a9a;
            margin: 2px 0 0;
        }

        .sheet-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .album-sheet .sheet-body {
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 18px;
            position: relative;
            background: #0b0b0b;
            padding-bottom: var(--sheet-safe-bottom, 18px);
        }

        .album-sheet .sheet-body::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .album-sheet .items-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }

        /*     .album-close, .modal-close, .popup-close {
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.8);  Change from background: to background-color:
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color .2s ease;  Remove background from transition
            backdrop-filter: blur(10px);
            color: #ffffff;
            font-size: 16px;
            font-weight: 400;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEgMUwxMSAxMSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTEgMUwxIDExIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px 12px;
        }

        .modal-close:hover, .album-close:hover, .popup-close:hover {
            border-color: rgba(255, 255, 255, 0.45);
           No background changes at all - just the brighter border
        }
        */
                
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .item-action-bar {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 1500;
        }

        .item-action-bar.hidden {
            display: none;
        }

       

       .read-more-popup {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         background: rgba(0,0,0,0.9);
         backdrop-filter: blur(20px);
         border: 1px solid rgba(255,255,255,0.2);
         border-radius: 16px;
         color: #fff;
         z-index: 1; /* above backdrop */

         /* 🔒 fixed visual size (independent of content length) */
         width: clamp(320px, 80vw, 420px);
         height: clamp(280px, 70vh, 420px);

         display: grid;
         grid-template-rows: auto 1fr;
       }

        .read-more-popup.hidden { display: none; }

        /* Header row (title + close) stays fixed */
        .read-more-popup .popup-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          padding: 14px 14px 10px 16px;
          border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .read-more-popup .popup-header h3 {
          margin: 0;
          font-size: 16px;
          font-weight: 600;
        }

        .read-more-popup .popup-close { position: static; }

        .read-more-popup .popup-body {
          padding: 14px 16px 16px 16px;
          overflow: auto; /* body scrolls; size stays fixed */
          -webkit-overflow-scrolling: touch;
        }

        .read-more-popup .popup-body p {
          font-size: 14px;
          color: #ccc;
          line-height: 1.6;
          margin: 0;
        }

        /* Optional scrollbar polish */
        .read-more-popup .popup-body::-webkit-scrollbar { width: 8px; }
        .read-more-popup .popup-body::-webkit-scrollbar-thumb {
          background: rgba(255,255,255,0.18);
          border-radius: 8px;
        }

        /* ====== Prevent page scroll when modal open ====== */
        body.modal-open { overflow: hidden; }

        /* ====== Mobile: pin modal over the 3D viewport half ======
           Assumes the 3D viewport is on the RIGHT half on mobile.
           Tweak the CSS variables to fit your header/menu/login space.
        */
        :root {
          --safe-top: 56px;        /* space for menu/login at top */
          --mobile-gutter: 12px;   /* side padding inside the right half */
          --mobile-bottom: 12px;   /* breathing room at bottom */
        }

        @media (max-width: 768px) {
          .read-more-popup {
            /* Place inside the RIGHT half */
            top: calc(var(--safe-top) + 8px);
            bottom: var(--mobile-bottom);
            left: calc(50vw + var(--mobile-gutter));
            right: var(--mobile-gutter);
            transform: none;
            width: auto;  /* let left/right define width (right-half minus gutters) */
            height: auto; /* use top/bottom to define height */
            max-height: none;
            border-radius: 14px;
          }
        }

        /* If your 3D viewport is on the LEFT half instead, add this class to #readMoreOverlay */
        @media (max-width: 768px) {
          .read-more-popup {
            top: var(--safe-top, 56px);      /* leaves space for menu/login */
            left: 50%;
            transform: translateX(-50%);     /* horizontal centering */
            
            width: calc(100vw - 32px);       /* fills most of the width with 16px side padding */
            max-width: 420px;                /* don’t get too wide */
            height: auto;                    /* height adapts to available space */
            max-height: calc(100vh - var(--safe-top, 56px) - 24px); /* safe top + bottom margin */
          }
        }
        
        .inventory-panel, .viewport-panel, .viewport-container {
            min-width: 0;
        }

        :root {
            --bottom-nav-h: 64px;
        }

        @media (max-width: 480px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50dvh 50dvh;   /* ✅ use dvh so it matches panel */
                height: 100dvh;
                overflow: hidden;
            }
            
            .viewport-panel {
                order: -1;
                height: 50dvh;
            }
            
            .viewport-container {
                height: 100%;
            }
            
            .inventory-panel {
                padding: 12px 12px 0 12px;
                height: 55dvh;
                overflow: hidden;
                background: #0a0a0a;
                border-right: none;
                border-top: 1px solid #1a1a1a;
            }
            
            .desktop-nav {
                display: none;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .inventory-content {
                padding-bottom: calc(var(--bottom-nav-h, 64px) + env(safe-area-inset-bottom, 0px) + 16px);
            }
            
            #characters .characters-grid {
                padding-bottom: 24px;
            }
            
            .collection-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .collection-card {
                padding: 16px;
            }
            
            .characters-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .unreleased-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .unlock-progress {
                display: none;
            }
            
            .top-nav {
                padding: 15px;
            }
            
            .menu-tray {
                top: 55px;
                left: 15px;
            }

            /* ✅ keep action bar snug to bottom of viewport, safe on iOS */
            .item-action-bar {
                bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            }
        }

        .circular-btn {
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.8); /* Change from background: to background-color: */
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color .2s ease; /* Remove background from transition */
            backdrop-filter: blur(10px);
            touch-action: manipulation;
            color: #ffffff;
            font-size: 0;
            text-indent: -9999px;
            /* Add the SVG background-image: */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEgMUwxMSAxMSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTEgMUwxIDExIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px 12px;
        }

        .circular-btn:hover {
            border-color: rgba(255, 255, 255, 0.45);
        }

        /* Action bar specific sizing */
        .item-action-bar .circular-btn {
            width: 30px;
            height: 30px;
            
        }

        /* Play button icon styling */
        .play-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMUwxMCA2TDIgMTFWMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px 12px;
        }

        .playing .play-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KPHJlY3QgeD0iOCIgeT0iMiIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==');
        }

        .read-more-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTkgM1Y5SDMiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxwYXRoIGQ9Ik05IDE1VjlIMTUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 16px 16px;
        }

        /* (REMOVED) broad mobile positioning block that overrode phone/tablet safe-area styles */

        /* Hide progress bars in overlays */
        .album-sheet .sheet-body .collection-progress,
        .album-sheet .sheet-header .sheet-progress,
        .album-overlay .collection-progress {
            display: none !important;
        }

        /* Fix unreleased card text width */
        .unreleased-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            padding-right: 0;
            word-wrap: break-word;
            hyphens: auto;
            line-height: 1.4;
        }

        .rarity-tag {
            display: none;
        }

        @media (max-width: 1024px) and (min-width: 481px) {
            .main-container {
              grid-template-columns: 1fr;
              grid-template-rows: 50dvh 50dvh; /* was 45vh 55vh */
              height: 100dvh;
              overflow: hidden;
            }
            
            .viewport-panel {
                order: -1;
                height: 50dvh;
            }
            
            .item-action-bar {
              position: absolute;
              left: 50%;
              bottom: calc(10px + env(safe-area-inset-bottom, 0px));
              transform: translateX(-50%);
              z-index: 1500;
            }

            .viewport-container {
                height: 100%;
            }
            
            .inventory-panel {
                padding: 20px 20px 0 20px;
                height: 50dvh;
                overflow: hidden;
                border-right: none;
                border-top: 1px solid #1a1a1a;
            }
            
            .desktop-nav {
                display: none;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .inventory-content {
                padding-bottom: calc(var(--bottom-nav-h, 64px) + env(safe-area-inset-bottom, 0px) + 16px);
            }
            
            .characters-grid, .unreleased-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            
            .album-sheet .sheet-body {
                --sheet-safe-bottom: calc(96px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* Prevent horizontal cutoff by allowing columns to shrink */
        .inventory-panel, .viewport-panel, .viewport-container { min-width: 0; }
        .viewport-container { width: 100%; height: 100%; }
        .viewport-panel canvas { display: block; width: 100% !important; height: 100% !important; }


    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <button class="menu-button" onclick="toggleMenu()">
            <div class="menu-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </button>
        <button class="login-button" onclick="handleLogin()">
            <div class="user-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
            </div>
        </button>
    </div>

    <!-- Menu Tray -->
    <div class="menu-tray" id="menuTray">
        <a href="/landing-page/" class="menu-item">Home</a>
        <a href="#" class="menu-item">Label</a>
        <a href="#" class="menu-item">Merch</a>
        <a href="/packs/" class="menu-item">Packs</a>
        <a href="/inventory/" class="menu-item">Inventory</a>
    </div>

    <div class="main-container">
        <!-- Inventory Panel -->
        <div class="inventory-panel">
            <!-- INVENTORY CONTENT (new wrapper) -->
            <div class="inventory-content">
            <!-- Characters Section -->
            <div id="characters" class="section active">
                <div class="characters-grid">
                    
                    <div class="character-card fixed" onclick="viewCharacter('sloucho')">
                        <div class="character-media">
                            <img src="/assets/thumbs/sloucho.png" alt="Sloucho">
                          </div>
                      <h3>Sloucho</h3>
                  
                    </div>
                    
                    <div class="character-card fixed" onclick="viewCharacter('ras')">
                        <div class="character-media">
                            <img src="/assets/thumbs/ras.png" alt="Rás">
                          </div>
                      <h3>Rás</h3>
                 
                    </div>
                    
                    <div class="character-card fixed" onclick="viewCharacter('supermaramu2000')">
                        <div class="character-media">
                            <img src="/assets/thumbs/supermaramu2000.png" alt="Super Maramu 2000">
                          </div>
                      <h3>Super Maramu 2000</h3>
             
                    </div>
                    
                </div>
            </div>

            <!-- Stems Section -->
            <div id="stems" class="section">
                <div class="collection-section">
                    <div class="collection-card">
                        <div class="collection-header">
                            <div class="collection-info">
                                <h3>ECHOES</h3>
                                <p>4 Songs</p>
                            </div>
                            <div class="collection-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 75%;"></div>
                                </div>
                                <span class="progress-text">75%</span>
                            </div>
                        </div>

                        <div class="items-grid">
                            <div class="item-card completed">
                                <div class="item-header">
                                    <div class="item-title">Just U</div>
                                    <div class="item-completion complete">5/5</div>
                                </div>
                                <div class="stems-row">
                                    <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
                                    <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
                                    <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
                                    <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
                                    <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
                                </div>
                            </div>

                            <div class="item-card">
                                <div class="item-header">
                                    <div class="item-title">Always Remember</div>
                                    <div class="item-completion">3/5</div>
                                </div>
                                <div class="stems-row">
                                    <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
                                    <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
                                    <div class="stem-slot empty" title="Music" onclick="view3DItem('stem', 'music')">M</div>
                                    <div class="stem-slot empty" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
                                    <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
                                </div>
                            </div>
                        </div>
                    </div>

<div class="collection-card" data-ep="NPC">
    <div class="collection-header">
        <div class="collection-info">
            <h3>NPC</h3>
            <p>9 Songs</p>
        </div>
        <div class="collection-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%;"></div>
            </div>
            <span class="progress-text">0%</span>
        </div>
    </div>
    <div class="items-grid">
        <div class="item-card">
        <div class="item-header">
            <div class="item-title">Mind Traveller</div>
            <div class="item-completion">4/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot empty" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Mutant</div>
            <div class="item-completion">2/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot empty" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot empty" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot empty" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Come Around</div>
            <div class="item-completion">4/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot empty" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Brand New</div>
            <div class="item-completion">4/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot empty" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Super Maramu 2000</div>
            <div class="item-completion">3/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot empty" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot empty" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Make it Work</div>
            <div class="item-completion">4/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot empty" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Two Thousands</div>
            <div class="item-completion">4/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot empty" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot collected" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title"> Rocks</div>
            <div class="item-completion">1/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot empty" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot collected" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot empty" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot empty" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot empty" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
<div class="item-card">
        <div class="item-header">
            <div class="item-title">Lights On (ft. Yamagōchi)</div>
            <div class="item-completion">3/5</div>
        </div>
        <div class="stems-row">
            <div class="stem-slot collected" title="Drums" onclick="view3DItem('stem', 'drums')">D</div>
            <div class="stem-slot empty" title="Bass" onclick="view3DItem('stem', 'bass')">B</div>
            <div class="stem-slot collected" title="Music" onclick="view3DItem('stem', 'music')">M</div>
            <div class="stem-slot collected" title="Vocals" onclick="view3DItem('stem', 'vocals')">V</div>
            <div class="stem-slot empty" title="Effects" onclick="view3DItem('stem', 'effects')">FX</div>
    </div>
    </div>
    </div>
    <div class="unlock-progress">
        Collect all stems for the 9 NPC tracks to unlock the <strong>SILVER SLOUCHO</strong> Character.
    </div>
</div>


                </div>
            </div>

            <!-- Fragments Section -->
            <div id="fragments" class="section">
                <div class="collection-section">
                    <div class="collection-card">
                        <div class="collection-header">
                            <div class="collection-info">
                                <h3>Siu</h3>
                                <p>5 Fragments</p>
                            </div>
                            <div class="collection-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 67%;"></div>
                                </div>
                                <span class="progress-text">67%</span>
                            </div>
                        </div>

                        <div class="items-grid">
                            <div class="item-card completed">
                                <div class="item-header">
                                    <div class="item-title">Protector of the Land</div>
                                    <div class="item-completion">2/3</div>
                                </div>
                                <div class="stems-row">
                                    <div class="fragment-slot collected" title="Entry #1" onclick="view3DItem('fragment', 'diary-entry-1')">1</div>
                                    <div class="fragment-slot collected" title="Entry #2" onclick="view3DItem('fragment', 'diary-entry-2')">2</div>
                                    <div class="fragment-slot empty" title="Entry #3">3</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="collection-card">
                        <div class="collection-header">
                            <div class="collection-info">
                                <h3> Anu </h3>
                                <p>5 Fragments</p>
                            </div>
                            <div class="collection-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 20%;"></div>
                                </div>
                                <span class="progress-text">20%</span>
                            </div>
                        </div>

                        <div class="items-grid">
                            <div class="item-card">
                                <div class="item-header">
                                    <div class="item-title">Protector of the Sea</div>
                                    <div class="item-completion">1/5</div>
                                </div>
                                <div class="stems-row">
                                    <div class="fragment-slot collected" title="Studio Notes" onclick="view3DItem('fragment', 'studio-notes')">📝</div>
                                    <div class="fragment-slot empty" title="Equipment List">🎛️</div>
                                    <div class="fragment-slot empty" title="Mix Notes">🎧</div>
                                    <div class="fragment-slot empty" title="Master Tape">📼</div>
                                    <div class="fragment-slot empty" title="Producer Notes">📊</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unreleased Section -->
            <div id="unreleased" class="section">
                <div class="unreleased-grid">
                    <div class="unreleased-card" onclick="view3DItem('unreleased', 'vault-demo')">
                        <!-- <div class="rarity-tag rarity-legendary">Legendary</div>-->
                        <h3>Something Else (ft. Kibo)</h3>
                    </div>
                    <div class="unreleased-card" onclick="view3DItem('unreleased', 'alternate-version')">
                        <!-- <div class="rarity-tag rarity-legendary">Legendary</div>-->
                        <h3>Love is Fear</h3>
                     
                    </div>
                </div>
            </div>

            </div>
            <!-- Desktop Navigation (moved to bottom + unchanged logic) -->
            <div class="desktop-nav">
                <button class="nav-tab active" onclick="showSection('characters')">Characters</button>
                <button class="nav-tab" onclick="showSection('stems')">Stems</button>
                <button class="nav-tab" onclick="showSection('fragments')">Fragments</button>
                <button class="nav-tab" onclick="showSection('unreleased')">Unreleased</button>
            </div>
        </div>

        <!-- 3D Viewport Panel -->
        <div class="viewport-panel">
          <div class="viewport-container" id="viewport">
            <!-- Three.js will append its <canvas> here -->

            <!-- Item Action Bar -->
            <div id="itemActionBar" class="item-action-bar hidden">
              <button id="playBtn" class="circular-btn play-btn" aria-label="Play/Pause"></button>
              <button id="readMoreBtn" class="circular-btn read-more-btn" aria-label="Read More"></button>
            </div>

            <!-- Viewport Controls (top-right buttons, if you re-enable them) -->
            <div class="viewport-controls">
              <!--
              <button class="control-btn" onclick="resetCamera()">Reset</button>
              <button class="control-btn" onclick="toggleAutoRotate()">Rotate</button>
              -->
            </div>

            <!-- Read More Popup -->
            <div id="readMorePopup" class="read-more-popup hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
              <div class="popup-header">
                <h3 id="popupTitle"></h3>
                <button class="popup-close circular-btn" id="popupCloseBtn" aria-label="Close"></button>
              </div>
              <div class="popup-body" id="popupText">
                <!-- long text goes here; it will scroll, not resize the modal -->
              </div>
            </div>

          </div>
        </div>
        
        <div id="readMoreOverlay" class="modal-overlay" aria-hidden="true">
          <div class="modal-backdrop" aria-hidden="true"></div>

          <!-- Your fixed-size modal -->
          <div id="readMorePopup" class="read-more-popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
            <div class="popup-header">
              <h3 id="popupTitle"></h3>
              <button class="popup-close circular-btn" id="popupCloseBtn" aria-label="Close"></button>
            </div>
            <div class="popup-body" id="popupText"></div>
          </div>
        </div>
                
                <!-- Item Info Panel
                <div class="item-info-panel" id="itemInfo">
                    <div class="item-title" id="itemTitle"></div>
                    <div class="item-description" id="itemDescription"></div>
                    <div class="item-actions">
                        <button class="play-btn" id="playBtn" onclick="toggleAudio()" style="display: none;">▶</button>
                    </div>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-items">
            <div class="nav-item active" onclick="showSectionMobile('characters')" data-section="characters">
                <div class="nav-icon">★</div>
            </div>
            <div class="nav-item" onclick="showSectionMobile('stems')" data-section="stems">
                <div class="nav-icon">♪</div>
            </div>
            <div class="nav-item" onclick="showSectionMobile('fragments')" data-section="fragments">
                <div class="nav-icon">◈</div>
            </div>
            <div class="nav-item" onclick="showSectionMobile('unreleased')" data-section="unreleased">
                <div class="nav-icon">⦿</div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="login-modal">
            <button class="modal-close circular-btn" onclick="closeLoginModal()"></button>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('login')">Account</button>
            </div>
            
            <form id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-input" placeholder="Email" required>
                </div>
                <button type="submit" id="loginSubmit" class="form-button">Create / Login</button>
            </form>
        </div>
    </div>
    
    <!-- Album Overlay -->
    <div class="album-overlay" id="albumOverlay" aria-hidden="true">
      <div class="album-sheet" role="dialog" aria-modal="true" aria-labelledby="albumSheetTitle">
        <div class="sheet-header">
          <div class="sheet-meta">
            <div class="sheet-title">
              <h3 id="albumSheetTitle"></h3>
              <p id="albumSheetSubtitle"></p>
            </div>
            <div class="sheet-progress">
              <div class="progress-bar"><div class="progress-fill" id="albumSheetFill" style="width:0%"></div></div>
              <span class="progress-text" id="albumSheetPct">0%</span>
            </div>
          </div>
          <button class="album-close circular-btn" id="albumCloseBtn" type="button"></button>
        </div>
        <div class="sheet-body" id="albumSheetBody"><!-- injected --></div>
      </div>
    </div>

    <!-- Fragments Overlay -->
    <div class="album-overlay" id="fragmentOverlay" aria-hidden="true">
      <div class="album-sheet" role="dialog" aria-modal="true" aria-labelledby="fragmentSheetTitle">
        <div class="sheet-header">
          <div class="sheet-meta">
            <div class="sheet-title">
              <h3 id="fragmentSheetTitle"></h3>
              <p id="fragmentSheetSubtitle"></p>
            </div>
            <div class="sheet-progress">
              <div class="progress-bar"><div class="progress-fill" id="fragmentSheetFill" style="width:0%"></div></div>
              <span class="progress-text" id="fragmentSheetPct">0%</span>
            </div>
          </div>
          <button class="album-close circular-btn" id="fragmentCloseBtn" type="button"></button>
        </div>
        <div class="sheet-body" id="fragmentSheetBody"><!-- injected --></div>
      </div>
    </div>


    <script>
        // Three.js Scene Setup
        let scene, camera, renderer, currentObject, autoRotate = false;
        let currentAudio = null;

        function initViewport() {
            const viewport = document.getElementById('viewport');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(viewport.clientWidth, viewport.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            viewport.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0xffffff, 0.3, 10);
            pointLight.position.set(-3, 3, 3);
            scene.add(pointLight);
            
            // Add default placeholder
            createPlaceholderScene();
            
            // Mouse controls
            let mouseDown = false;
            let mouseX = 0, mouseY = 0;
            
            viewport.addEventListener('mousedown', (e) => { mouseDown = true; mouseX = e.clientX; mouseY = e.clientY; });
            viewport.addEventListener('mouseup', () => mouseDown = false);
            viewport.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                if (currentObject) {
                    currentObject.rotation.y += deltaX * 0.01;
                    currentObject.rotation.x += deltaY * 0.01;
                }
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            animate();
        }

        function createPlaceholderScene() {
            if (currentObject) {
                scene.remove(currentObject);
            }
            
            const group = new THREE.Group();
            
            const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
            const cubeMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
            group.add(cube);
            
            const wireframeGeometry = new THREE.EdgesGeometry(cubeGeometry);
            const wireframeMaterial = new THREE.LineBasicMaterial({ color: 0x333333 });
            const wireframe = new THREE.LineSegments(wireframeGeometry, wireframeMaterial);
            group.add(wireframe);
            
            currentObject = group;
            scene.add(currentObject);
        }

        function create3DStem(stemType) {
            if (currentObject) scene.remove(currentObject);
            
            const group = new THREE.Group();
            
            // Base platform
            const platformGeometry = new THREE.CylinderGeometry(1.2, 1.2, 0.1);
            const platformMaterial = new THREE.MeshPhongMaterial({
                color: 0x111111,
                transparent: true,
                opacity: 0.6
            });
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.position.y = -1;
            group.add(platform);
            
            // Different shapes based on stem type
            let mainObject;
            switch(stemType) {
                case 'vocals':
                    const micGeometry = new THREE.CylinderGeometry(0.2, 0.2, 1.5);
                    const micMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                    mainObject = new THREE.Mesh(micGeometry, micMaterial);
                    
                    const micHead = new THREE.SphereGeometry(0.25, 16, 16);
                    const micHeadMesh = new THREE.Mesh(micHead, new THREE.MeshPhongMaterial({ color: 0xcccccc }));
                    micHeadMesh.position.y = 0.8;
                    mainObject.add(micHeadMesh);
                    break;
                    
                case 'guitar':
                    const guitarGeometry = new THREE.BoxGeometry(0.6, 1, 0.15);
                    const guitarMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                    mainObject = new THREE.Mesh(guitarGeometry, guitarMaterial);
                    
                    const neckGeometry = new THREE.BoxGeometry(0.08, 1.2, 0.1);
                    const neckMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
                    const neck = new THREE.Mesh(neckGeometry, neckMaterial);
                    neck.position.y = 1.1;
                    mainObject.add(neck);
                    break;
                    
                case 'drums':
                    const drumGeometry = new THREE.CylinderGeometry(0.5, 0.5, 0.3);
                    const drumMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                    mainObject = new THREE.Mesh(drumGeometry, drumMaterial);
                    break;
                    
                case 'bass':
                    const bassGeometry = new THREE.BoxGeometry(0.5, 0.8, 0.12);
                    const bassMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                    mainObject = new THREE.Mesh(bassGeometry, bassMaterial);
                    
                    const bassNeck = new THREE.BoxGeometry(0.06, 1.6, 0.08);
                    const bassNeckMesh = new THREE.Mesh(bassNeck, new THREE.MeshPhongMaterial({ color: 0xcccccc }));
                    bassNeckMesh.position.y = 1.2;
                    mainObject.add(bassNeckMesh);
                    break;
                    
                default:
                    const defaultGeometry = new THREE.CylinderGeometry(0.6, 0.6, 0.05);
                    const defaultMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
                    mainObject = new THREE.Mesh(defaultGeometry, defaultMaterial);
            }
            
            mainObject.position.y = 0;
            group.add(mainObject);
            
            addMinimalParticles(group);
            
            currentObject = group;
            scene.add(currentObject);
        }

        function create3DFragment(fragmentType) {
            if (currentObject) scene.remove(currentObject);
            
            const group = new THREE.Group();
            
            const platformGeometry = new THREE.CylinderGeometry(1.2, 1.2, 0.1);
            const platformMaterial = new THREE.MeshPhongMaterial({
                color: 0x111111,
                transparent: true,
                opacity: 0.6
            });
            const platform = new THREE.Mesh(platformGeometry, platformMaterial);
            platform.position.y = -1;
            group.add(platform);
            
            const scrollGeometry = new THREE.PlaneGeometry(1.2, 1.6);
            const scrollMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.9
            });
            const scroll = new THREE.Mesh(scrollGeometry, scrollMaterial);
            
            const glowGeometry = new THREE.PlaneGeometry(1.4, 1.8);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.1,
                side: THREE.DoubleSide
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            glow.position.z = -0.01;
            scroll.add(glow);
            
            group.add(scroll);
            addMinimalParticles(group);
            
            currentObject = group;
            scene.add(currentObject);
        }

        function addMinimalParticles(group) {
            const particleCount = 15;
            const particlesGeometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 3;
                positions[i + 1] = (Math.random() - 0.5) * 3;
                positions[i + 2] = (Math.random() - 0.5) * 3;
            }
            
            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const particlesMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.05,
                transparent: true,
                opacity: 0.3
            });
            
            const particles = new THREE.Points(particlesGeometry, particlesMaterial);
            group.add(particles);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (currentObject && autoRotate) {
                currentObject.rotation.y += 0.005;
            }
            
            if (currentObject) {
                currentObject.children.forEach(child => {
                    if (child instanceof THREE.Points) {
                        child.rotation.y += 0.002;
                        child.rotation.x += 0.001;
                    }
                });
            }
            
            renderer.render(scene, camera);
        }

        // Item Database
        const itemDatabase = {
            'shape-vocals': {
                title: 'Shape of You - Vocals',
                description: '',
                audio: 'shape-vocals.mp3',
                type: 'vocals'
            },
            'shape-guitar': {
                title: 'Shape of You - Guitar',
                description: 'The tropical house-inspired guitar riff that drives the entire song. This acoustic guitar pattern became one of the most recognizable hooks of the 2010s.',
                audio: 'shape-guitar.mp3',
                type: 'guitar'
            },
            'shape-bass': {
                title: 'Shape of You - Bass',
                description: 'Deep, rhythmic bass line that provides the foundation for the track\'s infectious groove.',
                audio: 'shape-bass.mp3',
                type: 'bass'
            },
            'shape-drums': {
                title: 'Shape of You - Drums',
                description: 'The minimalist but effective drum pattern that gives "Shape of You" its infectious groove. Perfect blend of electronic and acoustic percussion.',
                audio: 'shape-drums.mp3',
                type: 'drums'
            },
            'shape-effects': {
                title: 'Shape of You - Effects',
                description: 'Atmospheric effects and production elements that give the track its modern polish.',
                audio: 'shape-effects.mp3',
                type: 'default'
            },
            'perfect-vocals': {
                title: 'Perfect - Vocals',
                description: 'Heartfelt and romantic vocal performance from Ed\'s wedding ballad "Perfect". Showcases his emotional range and intimate singing style.',
                audio: 'perfect-vocals.mp3',
                type: 'vocals'
            },
            'perfect-guitar': {
                title: 'Perfect - Guitar',
                description: 'Gentle acoustic guitar that forms the emotional backbone of this romantic ballad.',
                audio: 'perfect-guitar.mp3',
                type: 'guitar'
            },
            'perfect-strings': {
                title: 'Perfect - Strings',
                description: 'Lush string arrangement that adds orchestral depth to the song\'s emotional climax.',
                audio: 'perfect-strings.mp3',
                type: 'default'
            },
            'diary-entry-1': {
                title: 'Artist\'s Journal - Entry #1',
                description: '"March 15th, 2008 - The first time I picked up a guitar, I knew music would be my life. My fingers were clumsy, the chords sounded awful, but there was something magical about creating sound from nothing. Today marks the beginning of everything I\'ll become."',
                type: 'fragment'
            },
            'diary-entry-2': {
                title: 'Artist\'s Journal - Entry #2',
                description: '"October 3rd, 2010 - Late nights in the studio, chasing that perfect melody that\'s been haunting my dreams. Coffee cups scattered everywhere, guitar picks lost in couch cushions. The song is almost there... I can feel it. Just need to find the right words to match the emotion."',
                type: 'fragment'
            },
            'studio-notes': {
                title: 'Studio Session Notes',
                description: '"Recording Notes - \'Blinding Lights\' Session: Used vintage Moog synth for the lead line, 808 drums processed through analog compressor. Vocals recorded with Neumann U87, double-tracked chorus for width. Magic happened at 3 AM when we found that perfect reverb setting."',
                type: 'fragment'
            },
            'vault-demo': {
                title: 'Vault Track Demo',
                description: 'An unreleased acoustic demo featuring raw, intimate vocals and stripped-down guitar work. This early version showcases the pure emotion before studio production.',
                audio: 'vault-demo.mp3',
                type: 'unreleased'
            },
            'alternate-version': {
                title: 'Alternate Mix',
                description: 'A different arrangement with extended bridge section and alternative vocal takes, offering a fresh perspective on a familiar song.',
                audio: 'alternate-version.mp3',
                type: 'unreleased'
            }
        };

        // UI Functions
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            
            const activeDesktopTab = document.querySelector(`[onclick="showSection('${sectionName}')"].nav-tab`);
            if (activeDesktopTab) activeDesktopTab.classList.add('active');
            if (typeof setActionBarForSection === 'function') setActionBarForSection(sectionName);
        }

        function showSectionMobile(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            const activeMobileTab = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeMobileTab) {
                activeMobileTab.classList.add('active');
            }
            if (typeof setActionBarForSection === 'function') setActionBarForSection(sectionName);
        }

        function view3DItem(itemType, itemId) {
            const item = itemDatabase[itemId];
            if (!item) return;
            
            if (itemType === 'stem') {
                create3DStem(item.type);
            } else if (itemType === 'fragment') {
                create3DFragment(item.type);
            } else if (itemType === 'unreleased') {
                create3DStem('default');
            }
            
            showItemActions(item);
        }

      /*  function showItemInfo(item) {
            const infoPanel = document.getElementById('itemInfo');
            const titleEl = document.getElementById('itemTitle');
            const descEl = document.getElementById('itemDescription');
            const playBtn = document.getElementById('playBtn');
            
            titleEl.textContent = item.title;
            descEl.textContent = item.description;
            
            if (item.audio && (item.type === 'vocals' || item.type === 'guitar' || item.type === 'bass' || item.type === 'drums' || item.type === 'default' || item.type === 'unreleased')) {
                playBtn.style.display = 'flex';
                playBtn.setAttribute('data-audio', item.audio);
                playBtn.innerHTML = '▶';
            } else {
                playBtn.style.display = 'none';
                stopAudio();
            }
            
            infoPanel.classList.add('visible');
        } */

        function viewCharacter(characterId) {
            if (currentObject) scene.remove(currentObject);
            
            const group = new THREE.Group();
            
            const bodyGeometry = new THREE.CylinderGeometry(0.4, 0.3, 1.8);
            const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0xffffff });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0;
            group.add(body);
            
            const headGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const headMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.2;
            group.add(head);
            
            currentObject = group;
            scene.add(currentObject);
            
            showItemActions({
                title: 'Taylor Swift',
              description: 'Legendary musical artist unlocked!...',
              type: 'character'
            });
        }

        function toggleAudio() {
            const playBtn = document.getElementById('playBtn');
            const audioFile = playBtn.getAttribute('data-audio');
            
            if (!audioFile) return;
            
            if (currentAudio && !currentAudio.paused) {
                stopAudio();
            } else {
                playAudio(audioFile);
            }
        }

        function playAudio(audioFile) {
            stopAudio();
            
            currentAudio = new Audio();
            currentAudio.src = `audio/${audioFile}`;
            
            simulateAudioPlayback();
            
            // Use class toggle instead of innerHTML
            document.body.classList.add('playing');
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            // Use class toggle instead of innerHTML
            document.body.classList.remove('playing');
        }
        
        function simulateAudioPlayback() {
            let progress = 0;
            const duration = 30;
            
            const interval = setInterval(() => {
                if (!currentAudio || currentAudio.paused) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 0.5;
                
                if (progress >= duration) {
                    stopAudio();
                    clearInterval(interval);
                }
            }, 500);
        }

        function resetCamera() {
            camera.position.set(0, 0, 5);
            camera.lookAt(0, 0, 0);
        }

        function toggleAutoRotate() {
            autoRotate = !autoRotate;
        }

        // Landing page UI functions
        function toggleMenu() {
            document.getElementById('menuTray').classList.toggle('open');
        }

        function handleLogin() {
            document.getElementById('loginModal').classList.add('show');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('show');
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.modal-tab');
            const loginForm = document.getElementById('loginForm');
            
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'login') {
                tabs[0].classList.add('active');
                loginForm.style.display = 'block';
            }
        }

        // Login form handler
        document.addEventListener('DOMContentLoaded', function() {
            const emailInput = document.getElementById('loginEmail');
            const loginBtn = document.getElementById('loginSubmit');

            if (emailInput && loginBtn) {
                function magicRedirect() {
                    const isInIframe = window !== window.top;
                    return isInIframe
                        ? 'https://ouchworld.netlify.app/landing-page/'
                        : `${location.origin}/landing-page/`;
                }

                loginBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const email = (emailInput.value || '').trim();
                    if (!email) return alert('Enter your email');
                    if (!window.supa?.auth) return alert('Auth not initialized');

                    loginBtn.disabled = true;
                    const oldText = loginBtn.textContent;
                    loginBtn.textContent = 'Sending…';
                    
                    const { error } = await window.supa.auth.signInWithOtp({
                        email,
                        options: { emailRedirectTo: magicRedirect() }
                    });
                    
                    loginBtn.disabled = false;
                    loginBtn.textContent = oldText;

                    if (error) alert(error.message);
                    else alert('Check your email for the magic link!');
                });
            }
        });

        
// ResizeObserver: keep renderer in sync with viewport container size
(function(){
  const viewportEl = document.getElementById('viewport');
  if (!viewportEl) return;
  if (window.__viewportResizeObs) { try { window.__viewportResizeObs.disconnect(); } catch(e){} }
  const ro = new ResizeObserver(entries => {
    for (const entry of entries) {
      try {
        if (renderer && camera) {
          const rect = entry.contentRect;
          camera.aspect = rect.width / rect.height;
          camera.updateProjectionMatrix();
          renderer.setSize(rect.width, rect.height);
        }
      } catch (e) { /* noop */ }
    }
  });
  ro.observe(viewportEl);
  window.__viewportResizeObs = ro;
})();

        // Event listeners
        window.addEventListener('resize', () => {
            const viewport = document.getElementById('viewport');
            if (viewport && renderer && camera) {
                camera.aspect = viewport.clientWidth / viewport.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(viewport.clientWidth, viewport.clientHeight);
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            const tray = document.getElementById('menuTray');
            const btn = document.querySelector('.menu-button');
            if (tray && !tray.contains(e.target) && !btn.contains(e.target)) {
                tray.classList.remove('open');
            }
        });

        // Close modal when clicking outside
        document.getElementById('loginModal').addEventListener('click', function(e) {
            if (e.target === this) closeLoginModal();
        });

        // Mobile zoom suppression from landing page
        /*     (function () {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) e.preventDefault();
                lastTouchEnd = now;
            }, { passive: false });
        })();
        
     document.addEventListener('gesturestart', e => e.preventDefault(), { passive: false });
        document.addEventListener('gesturechange', e => e.preventDefault(), { passive: false });
        document.addEventListener('gestureend', e => e.preventDefault(), { passive: false });
        document.addEventListener('touchstart', function (e) {
            if (e.touches && e.touches.length > 1) e.preventDefault();
        }, { passive: false });
        document.addEventListener('touchmove', function (e) {
            if (typeof e.scale === 'number' && e.scale !== 1) e.preventDefault();
        }, { passive: false });*/

        // Initialize viewport when page loads
        window.addEventListener('load', function() {
            if (typeof THREE !== 'undefined') {
                initViewport();
            } else {
                console.error('Three.js not loaded');
            }
        });
        
       
        
        // === Album Overlay logic (for STEMS tiles) ===
        (function initAlbumOverlay(){
          const overlay = document.getElementById('albumOverlay');
          const body    = document.getElementById('albumSheetBody');
          const titleEl = document.getElementById('albumSheetTitle');
          const subEl   = document.getElementById('albumSheetSubtitle');
          const pctEl   = document.getElementById('albumSheetPct');
          const fillEl  = document.getElementById('albumSheetFill');
          const closeBtn= document.getElementById('albumCloseBtn');
          if (!overlay || !body) return;

          // Helper: align to tiles gutters + top of the Stems grid
          // Helper: align to the left column (inventory-panel) gutters + top
          function positionAlbumSheetToStems() {
            const panel = document.querySelector('.inventory-panel');
            if (!panel) return;

            const rect = panel.getBoundingClientRect();
            const cs   = getComputedStyle(panel);

            const padL = parseFloat(cs.paddingLeft)  || 0;
            const padR = parseFloat(cs.paddingRight) || 0;
            const padT = parseFloat(cs.paddingTop)   || 0;

            // Distances from the viewport edges to the left-column *content* box
            const leftPad  = Math.round(rect.left + padL);
            const rightPad = Math.round(window.innerWidth - (rect.right - padR));
            const topPad   = Math.round(rect.top + padT);

            document.documentElement.style.setProperty('--album-pad-left',  leftPad + 'px');
            document.documentElement.style.setProperty('--album-pad-right', rightPad + 'px');
            document.documentElement.style.setProperty('--album-pad-top',   topPad  + 'px');
          }


          // Open overlay on any album tile in Stems
          document.querySelectorAll('#stems .collection-card').forEach(card => {
            card.addEventListener('click', (e) => {
              if (e.target.closest('a,button,[role="button"]')) return;

              const header = card.querySelector('.collection-header');
              const title  = header?.querySelector('.collection-info h3')?.textContent?.trim() || 'Album';
              const sub    = header?.querySelector('.collection-info p')?.textContent?.trim() || '';
              const pct    = header?.querySelector('.progress-text')?.textContent?.trim() || '';
              const fillW  = header?.querySelector('.progress-fill')?.style?.width || '0%';

              titleEl.textContent = title;
              subEl.textContent   = sub;
              pctEl.textContent   = pct;
              fillEl.style.width  = fillW;

              // Clone album contents so original DOM stays intact
              const cloned = document.createElement('div');
              const items = card.querySelector('.items-grid');
              const extra = card.querySelector('.unlock-progress');
              if (items) cloned.appendChild(items.cloneNode(true));
              if (extra) cloned.appendChild(extra.cloneNode(true));

              body.innerHTML = '';
              body.appendChild(cloned);

              // Align sheet to viewport left half with correct padding
              positionAlbumSheetToStems();

              // Show the sub-page
              overlay.classList.add('show');
              overlay.setAttribute('aria-hidden','false');

              // No body scroll locking — right side remains interactive
              closeBtn.focus();
            });
          });
          
          // === Fragment Overlay logic (for FRAGMENTS tiles) ===
          (function initFragmentOverlay(){
            const overlay = document.getElementById('fragmentOverlay');
            const body    = document.getElementById('fragmentSheetBody');
            const titleEl = document.getElementById('fragmentSheetTitle');
            const subEl   = document.getElementById('fragmentSheetSubtitle');
            const pctEl   = document.getElementById('fragmentSheetPct');
            const fillEl  = document.getElementById('fragmentSheetFill');
            const closeBtn= document.getElementById('fragmentCloseBtn');
            if (!overlay || !body) return;

            function positionFragmentSheet() {
              const panel = document.querySelector('.inventory-panel');
              if (!panel) return;
              const rect = panel.getBoundingClientRect();
              const cs   = getComputedStyle(panel);

              const padL = parseFloat(cs.paddingLeft)  || 0;
              const padR = parseFloat(cs.paddingRight) || 0;
              const padT = parseFloat(cs.paddingTop)   || 0;

              const leftPad  = Math.round(rect.left + padL);
              const rightPad = Math.round(window.innerWidth - (rect.right - padR));
              const topPad   = Math.round(rect.top + padT);

              document.documentElement.style.setProperty('--album-pad-left',  leftPad + 'px');
              document.documentElement.style.setProperty('--album-pad-right', rightPad + 'px');
              document.documentElement.style.setProperty('--album-pad-top',   topPad  + 'px');
            }

            // Open overlay on any fragment tile
            document.querySelectorAll('#fragments .collection-card').forEach(card => {
              card.addEventListener('click', (e) => {
                if (e.target.closest('a,button,[role="button"]')) return;

                const header = card.querySelector('.collection-header');
                const title  = header?.querySelector('.collection-info h3')?.textContent?.trim() || 'Fragment';
                const sub    = header?.querySelector('.collection-info p')?.textContent?.trim() || '';
                const pct    = header?.querySelector('.progress-text')?.textContent?.trim() || '';
                const fillW  = header?.querySelector('.progress-fill')?.style?.width || '0%';

                titleEl.textContent = title;
                subEl.textContent   = sub;
                pctEl.textContent   = pct;
                fillEl.style.width  = fillW;

                const cloned = document.createElement('div');
                const items = card.querySelector('.items-grid');
                const extra = card.querySelector('.unlock-progress');
                if (items) cloned.appendChild(items.cloneNode(true));
                if (extra) cloned.appendChild(extra.cloneNode(true));

                body.innerHTML = '';
                body.appendChild(cloned);

                positionFragmentSheet();

                overlay.classList.add('show');
                overlay.setAttribute('aria-hidden','false');
                closeBtn.focus();
              });
            });

            function closeOverlay(){
              overlay.classList.remove('show');
              overlay.setAttribute('aria-hidden','true');
            }

            closeBtn.addEventListener('click', closeOverlay);
            document.addEventListener('keydown', (e)=> {
              if (e.key === 'Escape' && overlay.classList.contains('show')) closeOverlay();
            });

            window.addEventListener('resize', () => {
              if (overlay.classList.contains('show')) positionFragmentSheet();
            });
          })();


          function closeOverlay(){
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden','true');
          }

          closeBtn.addEventListener('click', closeOverlay);
          document.addEventListener('keydown', (e)=> {
            if (e.key === 'Escape' && overlay.classList.contains('show')) closeOverlay();
          });

          // Keep alignment fresh on resize
          window.addEventListener('resize', () => {
            if (overlay.classList.contains('show')) positionAlbumSheetToStems();
          });
        })();
        
        // === Action Bar by Tab Context ===
        // === Item Action Bar & Popup Logic (per-item) ===
        (function initItemUI(){
          const actionBar   = document.getElementById('itemActionBar');
          const playBtn     = document.getElementById('playBtn');
          const readMoreBtn = document.getElementById('readMoreBtn');
          const popup       = document.getElementById('readMorePopup');
          const popupClose  = document.getElementById('popupCloseBtn');
          const popupTitle  = document.getElementById('popupTitle');
          const popupText   = document.getElementById('popupText');

          let currentItem = null;

          // Call this after you swap the 3D model for a clicked item
          window.showItemActions = function(item) {
            currentItem = item || null;
            actionBar.classList.remove('hidden');

            // Treat stems + unreleased as audio items
            const isAudioItem = !!(currentItem && currentItem.audio &&
              (currentItem.type === 'drums' ||
               currentItem.type === 'bass' ||
               currentItem.type === 'music'   ||
               currentItem.type === 'vocals'  ||
               currentItem.type === 'effects'||
               currentItem.type === 'unreleased'));

            // Only fragments + characters should trigger Read More
            const isReadItem = !!(currentItem &&
              (currentItem.type === 'fragment' || currentItem.type === 'character'));

            // Per-item UI: show only the relevant control
            playBtn.style.display     = isAudioItem ? 'block' : 'none';
            readMoreBtn.style.display = isReadItem  ? 'block' : 'none';

            // Wire audio file for your existing toggleAudio()
            if (isAudioItem) {
              playBtn.setAttribute('data-audio', currentItem.audio);
            } else {
              playBtn.removeAttribute('data-audio');
            }

            // Prep popup content for Read More (only relevant if visible)
            popupTitle.textContent = currentItem?.title || 'Info';
            popupText.textContent  = currentItem?.description || '';
          };



          // Attach listeners ONCE

          // Play/Pause → reuse existing audio pipeline
          playBtn.addEventListener('click', () => {
            if (!playBtn.hasAttribute('data-audio')) return;
            document.body.classList.toggle('playing');
            if (typeof toggleAudio === 'function') toggleAudio();
          });

          // Read More popup
          readMoreBtn.addEventListener('click', () => {
            popup.classList.remove('hidden');
            popup.setAttribute('aria-hidden','false');
          });
          popupClose.addEventListener('click', () => {
            popup.classList.add('hidden');
            popup.setAttribute('aria-hidden','true');
          });
        })();

        (function setBottomNavHeightVar(){
          const root = document.documentElement;
          const bn = document.querySelector('.bottom-nav');
          if (!bn) return;

          function update() {
            const h = Math.ceil(bn.getBoundingClientRect().height || 64);
            root.style.setProperty('--bottom-nav-h', h + 'px');
          }

          // Update on load, resize, orientation, and when the nav resizes
          window.addEventListener('load', update);
          window.addEventListener('resize', update);
          window.addEventListener('orientationchange', update);
          try {
            new ResizeObserver(update).observe(bn);
          } catch(_) { /* older browsers */ }

          update();
        })();
        
        (function(){
          const overlay  = document.getElementById('readMoreOverlay');
          const popup    = document.getElementById('readMorePopup');
          const closeBtn = document.getElementById('popupCloseBtn');
          const readMoreBtn = document.getElementById('readMoreBtn'); // 👈 your trigger button

          function openReadMore() {
            overlay.classList.add('open');
            document.body.classList.add('modal-open');

            // hide the button
            if (readMoreBtn) readMoreBtn.style.display = 'none';

            (closeBtn || popup)?.focus?.();
          }

          function closeReadMore() {
            overlay.classList.remove('open');
            document.body.classList.remove('modal-open');

            // show the button again
            if (readMoreBtn) readMoreBtn.style.display = '';
          }

          // wire it up
          readMoreBtn?.addEventListener('click', openReadMore);
          closeBtn?.addEventListener('click', closeReadMore);

          document.addEventListener('keydown', (e) => {
            if (overlay.classList.contains('open') && e.key === 'Escape') closeReadMore();
          });

          window.openReadMore = openReadMore;
          window.closeReadMore = closeReadMore;
        })();
        
    </script>

</body>
</html>
