<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>3D Music Inventory - Beta2</title>
   

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // Safe to expose in client
      window.__SUPABASE_URL = 'https://srdwkfjterotzjwzoauj.supabase.co';
      window.__SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ';
    </script>
    <script>
      window.supa = window.supabase.createClient(
        window.__SUPABASE_URL,
        window.__SUPABASE_ANON_KEY
      );
    </script>
    <script>
      (async function () {
        try {
          if (window.supa && location.hash && location.hash.includes('access_token')) {
            const params = new URLSearchParams(location.hash.slice(1));
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            const error = params.get('error');
            const error_description = params.get('error_description');
            if (error) {
              alert(`Authentication error: ${error_description || error}`);
              history.replaceState({}, '', location.pathname + location.search);
              return;
            }
            if (access_token && refresh_token) {
              const { error } = await window.supa.auth.setSession({ access_token, refresh_token });
              if (error) alert(`Session error: ${error.message}`); else window.location.reload();
            }
            history.replaceState({}, '', location.pathname + location.search);
          }
        } catch (e) { console.error('[supabase] Magic link processing failed:', e); }
      })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/DRACOLoader.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            font-weight: 400;
            line-height: 1.5;
        }

        .main-container {
            display: grid;
            grid-template-columns: minmax(320px, 1fr) 1fr;
            height: 100vh;
            gap: 0;
        }

        .inventory-panel {
            padding: 32px;
            background: #0a0a0a;
            border-right: 1px solid #1a1a1a;
            height: 100vh;
            padding-top: 80px;
            display: flex;
            flex-direction: column;
        }

        .inventory-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding-bottom: 12px;
        }

        .inventory-content::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .viewport-panel {
            background: #111111;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }

        .menu-button, .login-button {
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color .2s ease, background .2s ease;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .menu-button:hover, .login-button:hover {
            border-color: rgba(255, 255, 255, 0.45);
        }

        .menu-dots {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 3px;
            height: 3px;
            background: #fff;
            border-radius: 50%;
        }

        .user-icon {
            width: 16px;
            height: 16px;
            color: #fff;
        }

        .user-icon svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .menu-tray {
            position: fixed;
            top: 60px;
            left: 20px;
            width: 130px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            z-index: 999;
            transform: translateY(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all .3s ease;
            padding: 10px 0;
        }

        .menu-tray.open {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .menu-item {
            position: relative;
            display: block;
            width: 100%;
            padding: 6px 15px;
            color: #fff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 300;
            cursor: pointer;
            background: none;
            border: 0;
        }

        .menu-item::before {
            content: "";
            position: absolute;
            inset: 1px;
            left: 8px;
            right: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.12);
            opacity: 0;
            transform: scaleY(0.96);
            transition: opacity .15s ease, transform .2s ease;
            pointer-events: none;
        }

        .menu-item:hover::before, .menu-item:focus-visible::before {
            opacity: 1;
            transform: scaleY(1);
        }

        .menu-item, .menu-item * {
            position: relative;
            z-index: 1;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2001;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }
        
        
        #readMoreOverlay.rm-overlay {
          position: absolute;
          inset: 0;
          z-index: 2200;        /* lower than login modal if needed */
          display: none;
          --popup-vmargin: 16px; /* desktop default */
          --popup-hmargin: 16px;
        }
        #readMoreOverlay.rm-overlay.show { display: block; }


        #readMoreOverlay .rm-backdrop {
          position: absolute;
          inset: 0;
          background: rgba(0,0,0,0.45);
          pointer-events: auto; /* blocks clicks behind */
        }
        
        #readMoreOverlay .read-more-popup {
          position: absolute;
          top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.9);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255,255,255,0.2);
          border-radius: 16px;
          color: #fff;
          z-index: 1;

          width: clamp(320px, 80vw, 420px);
          height: 350px;
          
          display: flex;
          flex-direction: column;

          display: grid;
          grid-template-rows: auto 1fr;
        }

        #readMoreOverlay .read-more-popup .popup-header{
          display:flex;
          align-items:center;
          justify-content:space-between;gap:12px;
          padding:14px 14px 10px 16px;border-bottom:1px solid rgba(255,255,255,0.1);
        }
        #readMoreOverlay .read-more-popup .popup-close{position:static;}
        #readMoreOverlay .read-more-popup .popup-body{
          padding:14px 16px 16px;overflow:auto;-webkit-overflow-scrolling:touch;
        }

        /* Centered mobile variant (does NOT touch login modal) */
        @media (max-width: 768px){
          #readMoreOverlay .read-more-popup{
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 420px;

            /* ðŸ‘‡ CLAMP TO VIEWPORT CONTAINER INSTEAD OF 100vh */
            top: var(--safe-top, 56px);
            bottom: 12px;                 /* <= stops before inventory */
            height: auto;                 /* grow between top & bottom */
            max-height: none;             /* let top/bottom control size */

            display: grid;
            grid-template-rows: auto 1fr; /* header + scrollable body */
          }

          /* keep the inner content scrollable only */
          #readMoreOverlay .read-more-popup .popup-body{
            overflow: auto;
            -webkit-overflow-scrolling: touch;
          }
        }

        /* Optional: when Read-More is open, prevent page scroll without affecting other modals */
        body.rm-open { overflow: hidden; }
        
        

        .login-modal {
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 15px;
            width: 90%;
            max-width: 400px;
            position: relative;
            color: #fff;
        }

        .modal-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .modal-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 16px;
            padding: 8px 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all .2s ease;
        }

        .modal-tab.active {
            color: #fff;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 12px 15px;
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .form-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-button {
            width: 100%;
            background: rgba(255,255,255,0.92);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(17, 17, 17, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #1a1a1a;
            padding: 12px 20px;
            z-index: 1000;
        }

       
        
        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            color: #666666;
            touch-action: manipulation;
        }

        .nav-item.active {
            color: #ffffff;
        }

        .nav-icon {
            font-size: 18px;
            color: inherit;
            font-weight: normal;
        }

        .desktop-nav {
            display: flex;
            gap: 2px;
            margin-bottom: 0;
            background: #111111;
            border-radius: 8px 8px 0 0;
            border-top: 1px solid #1a1a1a;
            padding: 4px;
            margin-top: 12px;
            position: sticky;
            bottom: 0;
            z-index: 1;
        }

        .nav-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #666666;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
            flex: 1;
            text-align: center;
            touch-action: manipulation;
        }

        .nav-tab:hover {
            color: #ffffff;
        }

        .nav-tab.active {
            background: #1a1a1a;
            color: #ffffff;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .viewport-container {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            height: 100%;
            width: 100%;
            min-width: 0;
        }

        .viewport-panel canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        .viewport-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .item-info-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(40px);
            padding: 24px;
            border-top: 1px solid #1a1a1a;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        .item-info-panel.visible {
            transform: translateY(0);
        }

        .item-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .item-description {
            color: #cccccc;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 15px;
        }

        .item-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }

        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        /* 1) Lock the card height to your original size */
        .character-card.fixed{
          /* let the image row actually take the available height */
          grid-template-rows: minmax(0,1fr) auto auto;
        }

        .character-media{
          position: relative;
          display: grid;
          place-items: center;
          overflow: hidden;
          /* optional if you want a square window */
          /* aspect-ratio: 1 / 1; */
          min-height: 0; /* prevents grid min-content overflow */
        }

        .character-media img{
          width: 100%;
          height: 100%;
          object-fit: cover;   /* use 'contain' if you donâ€™t want cropping */
          display: block;
        }

        /* 4) Keep titles tidy so they don't steal space from the image */
        .character-name{
          margin: 0;
          line-height: 1.15;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .character-status{
          margin: 0;
          opacity: 0.8;
          font-size: 0.9rem;
        }

        /* Optional: responsive tweak so cards stay consistent on mobile */
        @media (max-width: 640px){
          .character-card.fixed{ --card-h: 180px; }
        }

        .character-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .character-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .character-card.locked {
            opacity: 0.5;
        }

        .character-card.locked::after {
            content: 'ðŸ”’';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 14px;
        }

        .character-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #1a1a1a;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .character-avatar-img{
          width:100%;
          aspect-ratio:1/1;
          object-fit:cover;
          border-radius:3px; /* or 50% if you want it round like now */
          background:#1a1a1a;
          display:block;
        }

        .character-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .character-card p {
            font-size: 13px;
            color: #888888;
            margin-bottom: 8px;
        }

        .character-card small {
            font-size: 12px;
            color: #666666;
        }

        .collection-section {
            display: grid;
            gap: 24px;
        }

        .collection-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 24px;
        }

        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 16px;
            cursor: pointer;
            user-select: none;
        }

        .collection-info h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .collection-info p {
            font-size: 14px;
            color: #888888;
        }

        .collection-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .progress-bar {
            width: 80px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #ffffff;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .progress-text {
            font-size: 13px;
            color: #888888;
            font-weight: 500;
        }

        .items-grid {
            display: grid;
            gap: 12px;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            max-height: 9999px;
            opacity: 1;
            transition: max-height .35s ease, opacity .25s ease, margin .25s ease, padding .25s ease;
        }

        .items-grid::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .item-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .item-card:hover {
            border-color: #333333;
            background: #111111;
        }

        .item-card.completed {
            border-color: #333333;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .item-completion {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            color: #888888;
        }

        .item-completion.complete {
            background: #ffffff;
            color: #0a0a0a;
        }

        .stems-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .stem-slot, .fragment-slot {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #333333;
            transition: all 0.2s ease;
            cursor: pointer;
            background: #1a1a1a;
            color: #666666;
        }

        .stem-slot.collected, .fragment-slot.collected {
            background: #ffffff;
            border-color: #ffffff;
            color: #0a0a0a;
        }

        .stem-slot.collected:hover, .fragment-slot.collected:hover {
            transform: scale(1.05);
        }

        .stem-slot.empty, .fragment-slot.empty {
            background: #0a0a0a;
            cursor: not-allowed;
            border-color: #1a1a1a;
        }

        .unlock-progress {
            margin-top: 16px;
            padding: 16px;
            background: #0a0a0a;
            border-radius: 8px;
            border: 1px solid #1a1a1a;
            font-size: 13px;
            color: #cccccc;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            max-height: 9999px;
            opacity: 1;
            transition: max-height .35s ease, opacity .25s ease, margin .25s ease, padding .25s ease;
        }

        .unlock-progress::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .unlock-progress.ready {
            border-color: #333333;
            background: #111111;
        }

        .collection-card.collapsed .items-grid,
        .collection-card.collapsed .unlock-progress {
            max-height: 0;
            opacity: 0;
            margin-top: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }

        .collection-header .collapse-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #fff;
            font-size: 12px;
            line-height: 1;
            transition: transform .2s ease, background .2s ease, border-color .2s ease;
        }

        .collection-header .collapse-toggle:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.2);
        }

        .collection-card.collapsed .collapse-toggle {
            transform: rotate(-90deg);
        }

        .unreleased-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .unreleased-card {
            background: #111111;
            border: 1px solid #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }

        .unreleased-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
        }

        .rarity-tag {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rarity-common { background: #333333; color: #ffffff; }
        .rarity-rare { background: #ffffff; color: #0a0a0a; }
        .rarity-epic { background: #ffffff; color: #0a0a0a; }
        .rarity-legendary { background: #ffffff; color: #0a0a0a; }

        .unreleased-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            padding-right: 60px;
        }

        .unreleased-card p {
            font-size: 13px;
            color: #888888;
            line-height: 1.5;
        }

        input, textarea, select {
            font-size: 16px;
        }

        button, a, .menu-button, .login-button, .nav-item, .nav-tab {
            touch-action: manipulation;
        }

        #stems .collection-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        #stems .collection-card {
            padding: 16px;
            cursor: pointer;
            transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
        }

        #stems .collection-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
        }

        #stems .collection-card .items-grid,
        #stems .collection-card .unlock-progress {
            display: none !important;
        }

        #stems .collection-card .collection-header {
            margin-bottom: 0;
            align-items: center;
        }

        #stems .collection-card .collection-info h3 {
            font-size: 16px;
        }

        #stems .collection-card .collection-info p {
            font-size: 12px;
            color: #9a9a9a;
        }

        #stems .collection-card .progress-bar {
            width: 72px;
        }

        #fragments .collection-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        #fragments .collection-card {
            padding: 16px;
            cursor: pointer;
            transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
        }

        #fragments .collection-card:hover {
            transform: translateY(-2px);
            border-color: #333333;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
        }

        #fragments .collection-card .items-grid,
        #fragments .collection-card .unlock-progress {
            display: none !important;
        }

        #fragments .collection-card .collection-header {
            margin-bottom: 0;
            align-items: center;
        }

        #fragments .collection-card .collection-info h3 {
            font-size: 16px;
        }

        #fragments .collection-card .collection-info p {
            font-size: 12px;
            color: #9a9a9a;
        }

        #fragments .collection-card .progress-bar {
            width: 72px;
        }

        .album-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            display: block;
            z-index: 2000;
            pointer-events: none;
            padding: var(--album-pad-top, 24px) var(--album-pad-right, 24px) 24px var(--album-pad-left, 24px);
        }

        .album-overlay .album-sheet {
            display: none;
        }

        .album-overlay.show .album-sheet {
            display: grid;
        }

        .album-sheet {
            pointer-events: auto;
            width: 100%;
            height: calc(100dvh - var(--album-pad-top, 24px) - 24px);
            max-height: calc(100dvh - var(--album-pad-top, 24px) - 24px);
            background: #0b0b0b;
            border: 1px solid #1a1a1a;
            border-radius: 14px;
            overflow: hidden;
            grid-template-rows: auto 1fr;
            box-shadow: 0 20px 60px rgba(0,0,0,.45);
            min-width: 360px;
        }

        .album-sheet .sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 18px;
            border-bottom: 1px solid #1a1a1a;
            background: linear-gradient(180deg,#0f0f0f,#0a0a0a);
        }

        .sheet-meta {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sheet-title h3 {
            font-size: 18px;
            margin: 0;
        }

        .sheet-title p {
            font-size: 13px;
            color: #9a9a9a;
            margin: 2px 0 0;
        }

        .sheet-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .album-sheet .sheet-body {
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            padding: 18px;
            position: relative;
            background: #0b0b0b;
            padding-bottom: var(--sheet-safe-bottom, 18px);
        }

        .album-sheet .sheet-body::-webkit-scrollbar {
            width: 0 !important;
            height: 0 !important;
        }

        .album-sheet .items-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }

                
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .item-action-bar {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 1500;
        }

        .item-action-bar.hidden {
            display: none;
        }

       

       .read-more-popup {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         background: rgba(0,0,0,0.9);
         backdrop-filter: blur(20px);
         border: 1px solid rgba(255,255,255,0.2);
         border-radius: 16px;
         padding: 20px;
         width: 90%;
         max-width: 400px;
         z-index: 2000;
         color: #fff;
       }

        .read-more-popup.hidden {
            display: none;
        }

        .read-more-popup .popup-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .read-more-popup h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .read-more-popup p {
            font-size: 14px;
            color: #ccc;
            margin: 0;
        }
        
        .inventory-panel, .viewport-panel, .viewport-container {
            min-width: 0;
        }

        :root {
            --bottom-nav-h: 64px;
        }

        @media (max-width: 480px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 50dvh 50dvh;   /* âœ… use dvh so it matches panel */
                height: 100dvh;
                overflow: hidden;
            }
            
            .viewport-panel {
                order: -1;
                height: 50dvh;
            }
            
            .viewport-container {
                height: 100%;
            }
            
            .inventory-panel {
                padding: 12px 12px 0 12px;
                height: 55dvh;
                overflow: hidden;
                background: #0a0a0a;
                border-right: none;
                border-top: 1px solid #1a1a1a;
            }
            
            .desktop-nav {
                display: none;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .inventory-content {
                padding-bottom: calc(var(--bottom-nav-h, 64px) + env(safe-area-inset-bottom, 0px) + 16px);
            }
            
            #characters .characters-grid {
                padding-bottom: 24px;
            }
            
            .collection-section {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .collection-card {
                padding: 16px;
            }
            
            .characters-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .unreleased-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .unlock-progress {
                display: none;
            }
            
            .top-nav {
                padding: 15px;
            }
            
            .menu-tray {
                top: 55px;
                left: 15px;
            }

            /* âœ… keep action bar snug to bottom of viewport, safe on iOS */
            .item-action-bar {
                bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            }
        }

        .circular-btn {
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.8); /* Change from background: to background-color: */
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: border-color .2s ease; /* Remove background from transition */
            backdrop-filter: blur(10px);
            touch-action: manipulation;
            color: #ffffff;
            font-size: 0;
            text-indent: -9999px;
            /* Add the SVG background-image: */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEgMUwxMSAxMSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTEgMUwxIDExIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px 12px;
        }

        .circular-btn:hover {
            border-color: rgba(255, 255, 255, 0.45);
        }

        /* Action bar specific sizing */
        .item-action-bar .circular-btn {
            width: 30px;
            height: 30px;
            
        }

        /* Play button icon styling */
        .play-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIgMUwxMCA2TDIgMTFWMVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 12px 12px;
        }

        .playing .play-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iMTIiIHZpZXdCb3g9IjAgMCAxMiAxMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KPHJlY3QgeD0iOCIgeT0iMiIgd2lkdGg9IjIiIGhlaWdodD0iOCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==');
        }

        .read-more-btn {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgiIGhlaWdodD0iMTgiIHZpZXdCb3g9IjAgMCAxOCAxOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTkgM1Y5SDMiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxwYXRoIGQ9Ik05IDE1VjlIMTUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 16px 16px;
        }

        /* (REMOVED) broad mobile positioning block that overrode phone/tablet safe-area styles */

        /* Hide progress bars in overlays */
        .album-sheet .sheet-body .collection-progress,
        .album-sheet .sheet-header .sheet-progress,
        .album-overlay .collection-progress {
            display: none !important;
        }

        /* Fix unreleased card text width */
        .unreleased-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #ffffff;
            padding-right: 0;
            word-wrap: break-word;
            hyphens: auto;
            line-height: 1.4;
        }

        .rarity-tag {
            display: none;
        }

        @media (max-width: 1024px) and (min-width: 481px) {
            .main-container {
              grid-template-columns: 1fr;
              grid-template-rows: 50dvh 50dvh; /* was 45vh 55vh */
              height: 100dvh;
              overflow: hidden;
            }
            
            .viewport-panel {
                order: -1;
                height: 50dvh;
            }
            
            .item-action-bar {
              position: absolute;
              left: 50%;
              bottom: calc(10px + env(safe-area-inset-bottom, 0px));
              transform: translateX(-50%);
              z-index: 1500;
            }

            .viewport-container {
                height: 100%;
            }
            
            .inventory-panel {
                padding: 20px 20px 0 20px;
                height: 50dvh;
                overflow: hidden;
                border-right: none;
                border-top: 1px solid #1a1a1a;
            }
            
            .desktop-nav {
                display: none;
            }
            
            .bottom-nav {
                display: block;
            }
            
            .inventory-content {
                padding-bottom: calc(var(--bottom-nav-h, 64px) + env(safe-area-inset-bottom, 0px) + 16px);
            }
            
            .characters-grid, .unreleased-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
            
            .album-sheet .sheet-body {
                --sheet-safe-bottom: calc(96px + env(safe-area-inset-bottom, 0px));
            }
        }
        
        
        /* Any card marked as locked will appear dimmed */
        .character-card.locked,
        .album-card.locked,
        .collection-card.locked,
        .unreleased-card.locked {
          opacity: 0.4;
          filter: grayscale(100%);
          pointer-events: none; /* optional: prevent clicking locked items */
        }


        /* Prevent horizontal cutoff by allowing columns to shrink */
        .inventory-panel, .viewport-panel, .viewport-container { min-width: 0; }
        .viewport-container { width: 100%; height: 100%; }
        .viewport-panel canvas { display: block; width: 100% !important; height: 100% !important; }


    </style>
</head>
<body>
  <!-- Top Navigation -->
  <div class="top-nav">
    <button class="menu-button" id="menuBtn">
      <div class="menu-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </button>
    <button class="login-button" id="loginBtn">
      <div class="user-icon">
        <svg viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4
                   1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8
                   1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
    </button>
  </div>

  <!-- Menu Tray -->
  <div class="menu-tray" id="menuTray">
    <a href="/landing-page/" class="menu-item">Home</a>
    <a href="#" class="menu-item">Label</a>
    <a href="#" class="menu-item">Merch</a>
    <a href="/packs/" class="menu-item">Packs</a>
    <a href="/inventory/" class="menu-item">Inventory</a>
  </div>

  <div class="main-container">
    <!-- Inventory Panel -->
    <div class="inventory-panel">
      <div class="desktop-nav">
        <button class="nav-tab active" data-target="characters">Characters</button>
        <button class="nav-tab" data-target="stems">Stems</button>
        <button class="nav-tab" data-target="fragments">Fragments</button>
        <button class="nav-tab" data-target="unreleased">Unreleased</button>
        <button class="nav-tab" data-target="albums">Albums</button>
      </div>

      <div class="inventory-content">
        <!-- === Inventory Summary (Balance + Owned Items) === -->
        <div id="summary" class="collection-card" style="margin-bottom:16px;">
          <div class="collection-header" style="cursor:auto">
            <div class="collection-info">
              <h3>Balance</h3>
              <p><span id="balanceCoin">0</span> COIN</p>
            </div>
          </div>
          <div class="items-grid" id="ownedItemsList"></div>
        </div>

        <section id="characters" class="section active">
          <div id="characters-grid" class="characters-grid"></div>
        </section>

        <section id="stems" class="section">
          <div id="stems-collections" class="collection-section"></div>
        </section>

        <section id="fragments" class="section">
          <div id="fragments-grid" class="collection-section"></div>
        </section>

        <section id="unreleased" class="section">
          <div id="unreleased-grid" class="unreleased-grid"></div>
        </section>

        <section id="albums" class="section">
          <div id="albums-grid" class="albums-grid"></div>
        </section>
      </div>
    </div>

    <!-- Audio (keep inside main grid so it sits with the viewport column) -->
    <audio id="audio-player"></audio>

    <!-- Viewport Panel (second grid column) -->
    <div class="viewport-panel">
      <div class="viewport-container" id="viewport">
        <!-- Three.js will append its <canvas> here -->

        <!-- Item Action Bar -->
        <div class="item-action-bar hidden" id="itemActionBar">
          <button class="circular-btn play-btn" id="playBtn" aria-label="Play/Pause"></button>
          <button class="circular-btn read-more-btn" id="readMoreBtn" aria-label="Read More"></button>
        </div>

        <!-- Read More Overlay -->
        <div id="readMoreOverlay" class="rm-overlay" aria-hidden="true">
          <div class="rm-backdrop" aria-hidden="true"></div>
          <div class="read-more-popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
            <div class="popup-header">
              <h3 id="popupTitle"></h3>
              <button class="popup-close circular-btn" id="popupCloseBtn" aria-label="Close"></button>
            </div>
            <div class="popup-body" id="popupText"></div>
          </div>
        </div>

        <div class="viewport-controls"></div>
      </div>
    </div>
  </div> <!-- /.main-container -->


  <!-- Mobile Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-items">
      <div class="nav-item active" data-section="characters">
        <div class="nav-icon">â˜…</div>
      </div>
      <div class="nav-item" data-section="stems">
        <div class="nav-icon">â™ª</div>
      </div>
      <div class="nav-item" data-section="fragments">
        <div class="nav-icon">â—ˆ</div>
      </div>
      <div class="nav-item" data-section="unreleased">
        <div class="nav-icon">â¦¿</div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="modal-overlay" id="loginModal">
    <div class="login-modal">
      <button class="modal-close circular-btn" id="loginCloseBtn"></button>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="login">Account</button>
      </div>
      
      <form id="loginForm" onsubmit="return false;">
        <div class="form-group">
          <input type="email" id="loginEmail" class="form-input" placeholder="Email" required>
        </div>
        <button type="submit" id="loginSubmit" class="form-button">Create / Login</button>
      </form>
    </div>
  </div>

  <!-- Album Overlay -->
  <div class="album-overlay" id="albumOverlay" aria-hidden="true">
    <div class="album-sheet" role="dialog" aria-modal="true" aria-labelledby="albumSheetTitle">
      <div class="sheet-header">
        <div class="sheet-meta">
          <div class="sheet-title">
            <h3 id="albumSheetTitle"></h3>
            <p id="albumSheetSubtitle"></p>
          </div>
          <div class="sheet-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="albumSheetFill" style="width:0%"></div>
            </div>
            <span class="progress-text" id="albumSheetPct">0%</span>
          </div>
        </div>
        <button class="album-close circular-btn" id="albumCloseBtn" type="button"></button>
      </div>
      <div class="sheet-body" id="albumSheetBody"><!-- injected --></div>
    </div>
  </div>

  <!-- Fragments Overlay -->
  <div class="album-overlay" id="fragmentOverlay" aria-hidden="true">
    <div class="album-sheet" role="dialog" aria-modal="true" aria-labelledby="fragmentSheetTitle">
      <div class="sheet-header">
        <div class="sheet-meta">
          <div class="sheet-title">
            <h3 id="fragmentSheetTitle"></h3>
            <p id="fragmentSheetSubtitle"></p>
          </div>
          <div class="sheet-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="fragmentSheetFill" style="width:0%"></div>
            </div>
            <span class="progress-text" id="fragmentSheetPct">0%</span>
          </div>
        </div>
        <button class="album-close circular-btn" id="fragmentCloseBtn" type="button"></button>
      </div>
      <div class="sheet-body" id="fragmentSheetBody"><!-- injected --></div>
    </div>
  </div>



  <script>
  /***************************
   * THREE.JS VIEWPORT
   ***************************/
  let scene, camera, renderer, currentObject, autoRotate = false;

  function initViewport() {
    const viewport = document.getElementById('viewport');
    if (!viewport) {
      console.error('Missing #viewport element');
      return;
    }
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);
    camera = new THREE.PerspectiveCamera(75, viewport.clientWidth / viewport.clientHeight, 0.1, 1000);
    camera.position.z = 5;
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(viewport.clientWidth, viewport.clientHeight);
    renderer.shadowMap.enabled = true;
    viewport.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0x404040, 0.4));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(5,5,5);
    scene.add(dir);
    const pt = new THREE.PointLight(0xffffff, 0.3, 10);
    pt.position.set(-3,3,3);
    scene.add(pt);

    try {
      const ro = new ResizeObserver(entries => {
        for (const entry of entries) {
          const { width, height } = entry.contentRect;
          camera.aspect = width / height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        }
      });
      ro.observe(viewport);
    } catch(_) {}

    createPlaceholderScene();
    animate();
  }

  function createPlaceholderScene() {
    if (currentObject) scene.remove(currentObject);
    const group = new THREE.Group();
    const cube = new THREE.Mesh(
      new THREE.BoxGeometry(1,1,1),
      new THREE.MeshPhongMaterial({ color:0xffffff, opacity:0.8, transparent:true })
    );
    group.add(cube);
    currentObject = group;
    scene.add(group);
  }
  function create3DStem(type) {
    if (currentObject) scene.remove(currentObject);
    const group = new THREE.Group();
    let mainObject;
    switch(type) {
      case "vocals": mainObject = new THREE.Mesh(new THREE.CylinderGeometry(0.2,0.2,1.5), new THREE.MeshPhongMaterial({color:0xffffff})); break;
      case "guitar": mainObject = new THREE.Mesh(new THREE.BoxGeometry(0.6,1,0.15), new THREE.MeshPhongMaterial({color:0xffffff})); break;
      case "bass":   mainObject = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.8,0.12), new THREE.MeshPhongMaterial({color:0xffffff})); break;
      case "drums":  mainObject = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,0.3), new THREE.MeshPhongMaterial({color:0xffffff})); break;
      default:       mainObject = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.05), new THREE.MeshPhongMaterial({color:0xffffff}));
    }
    group.add(mainObject);
    currentObject = group;
    scene.add(group);
  }
  function create3DFragment() {
    if (currentObject) scene.remove(currentObject);
    const group = new THREE.Group();
    const scroll = new THREE.Mesh(
      new THREE.PlaneGeometry(1.2,1.6),
      new THREE.MeshPhongMaterial({color:0xffffff, side:THREE.DoubleSide, transparent:true, opacity:0.9})
    );
    group.add(scroll);
    currentObject = group;
    scene.add(group);
  }
  function animate() {
    requestAnimationFrame(animate);
    if (currentObject && autoRotate) currentObject.rotation.y += 0.005;
    renderer.render(scene,camera);
  }

  /***************************
   * ACTION BAR + ITEM LOGIC
   ***************************/
  const actionBar   = document.getElementById("itemActionBar");
  const audioEl     = document.getElementById("audio-player");
  const playBtn     = document.getElementById("playBtn");
  const readMoreBtn = document.getElementById("readMoreBtn");
  const popupTitle  = document.getElementById("popupTitle");
  const popupText   = document.getElementById("popupText");
  const readMoreOverlay = document.getElementById("readMoreOverlay");
  const popupCloseBtn   = document.getElementById("popupCloseBtn");

  function showItemActions(item) {
    const hasAudio = !!item.audio;
    const hasDesc  = !!item.description;
    actionBar.classList.toggle("hidden", !hasAudio && !hasDesc);
    if (hasAudio) {
      audioEl.src = item.audio;
      playBtn.style.display = "block";
    } else {
      audioEl.removeAttribute("src");
      playBtn.style.display = "none";
    }
    if (hasDesc) {
      popupTitle.textContent = item.title || item.name || "";
      popupText.textContent  = item.description;
      readMoreBtn.style.display = "block";
    } else {
      popupTitle.textContent = "";
      popupText.textContent = "";
      readMoreBtn.style.display = "none";
    }
  }
  playBtn.addEventListener("click", () => {
    if (!audioEl.src) return;
    if (audioEl.paused) { audioEl.play(); actionBar.classList.add("playing"); }
    else { audioEl.pause(); actionBar.classList.remove("playing"); }
  });
  readMoreBtn.addEventListener("click", () => {
    readMoreOverlay.classList.add("show");
    readMoreOverlay.setAttribute("aria-hidden","false");
  });
  popupCloseBtn.addEventListener("click", () => {
    readMoreOverlay.classList.remove("show");
    readMoreOverlay.setAttribute("aria-hidden","true");
  });

  /***************************
   * HELPERS
   ***************************/
      function asArray(val) {
        if (Array.isArray(val)) return val;
        if (val && typeof val === 'object') return Object.values(val);
        return [];
      }

      // Normalize the /api/catalog payload regardless of server shape/aliases
      function normalizeCatalog(c) {
        const src0 = c || {};
        const src = src0.catalog ? src0.catalog : src0;

        // Common alias fallbacks
        const eps             = src.eps             ?? src.albums       ?? src.albumSets       ?? [];
        const singles         = src.singles         ?? src.tracks       ?? [];
        const covers          = src.covers          ?? src.albumCovers  ?? src.coversAll       ?? [];
        const fragmentSets    = src.fragmentSets    ?? src.fragments    ?? src.fragmentsets    ?? [];
        const unreleased      = src.unreleased      ?? src.unreleasedTracks ?? src.unreleased_items ?? [];
        const goldenCharacters= src.goldenCharacters?? src.golden       ?? src.golden_chars    ?? [];

        return {
          eps:              asArray(eps),
          singles:          asArray(singles),
          covers:           asArray(covers),
          fragmentSets:     asArray(fragmentSets),
          unreleased:       asArray(unreleased),
          goldenCharacters: asArray(goldenCharacters),
        };
      }


  /***************************
   * RENDER FUNCTIONS (progress + all/greyed)
   ***************************/
  // Example: Characters (all, grey out locked)
  function renderCharactersAll(inv = {}, catalog = {}) {
    const container = document.getElementById('characters-grid');
    if (!container) return;
    container.innerHTML = '';

    const unlocked = new Set((inv.progress?.characters || []).map(c => c.characterId));

    // Union: fragmentSets âˆª goldenCharacters âˆª unlocked (fallbacks)
    const all = new Map();

    asArray(catalog.fragmentSets).forEach(fs => {
      const id = fs.characterId || fs.id;
      if (!id) return;
      all.set(id, { id, name: fs.name, image: fs.image || fs.coverImage || fs.artUrl || '' });
    });

    asArray(catalog.goldenCharacters).forEach(gc => {
      const id = gc.characterId || gc.id;
      if (!id) return;
      if (!all.has(id)) all.set(id, { id, name: gc.name, image: gc.image || '' });
    });

    // Fallback: infer characters from fragment progress if catalog is thin
    (inv.progress?.fragments || []).forEach(f => {
      const id = f.characterId || f.id;
      if (!id) return;
      if (!all.has(id)) all.set(id, { id, name: f.name, image: '' });
    });

    // Fallback: unlocked characters themselves (in case catalog is empty)
    (inv.progress?.characters || []).forEach(c => {
      const id = c.characterId || c.id;
      if (!id) return;
      if (!all.has(id)) all.set(id, { id, name: c.name, image: c.image || '' });
    });

    const list = Array.from(all.values());
    if (!list.length) {
      container.innerHTML = `<div class="item-card" style="text-align:center;opacity:.6">No characters found.</div>`;
      return;
    }

    list.forEach(c => {
      const locked = !unlocked.has(c.id);
      const card = document.createElement('div');
      card.className = 'character-card' + (locked ? ' locked' : '');
      card.innerHTML = `
        <div class="character-thumb"><img loading="lazy" src="${c.image || ''}" alt=""></div>
        <div class="character-name">${c.name || 'Character'}</div>
      `;
      card.addEventListener('click', () => {
        if (locked) return;
        create3DStem('default');
        showItemActions({ title: c.name, description: 'Unlocked character' });
      });
      container.appendChild(card);
    });
  }

  // EP grouping
  function makeStemChips(owned=0,total=0){
    const labels=['D','B','M','V','FX'];
    const row=document.createElement("div");row.className="stems-row";
    for(let i=0;i<total;i++){const slot=document.createElement("div");slot.className="stem-slot"+(i<owned?" collected":" empty");slot.textContent=labels[i]||"â€¢";row.appendChild(slot);}
    return row;
  }
  function makeSongRow(name,owned,total){
    const wrapper=document.createElement("div");wrapper.className="collection-card";wrapper.style.padding="12px";wrapper.style.margin="0";
    wrapper.innerHTML=`<div class="collection-header" style="margin-bottom:8px;"><div class="collection-info"><h3 style="font-size:14px">${name}</h3></div><div class="item-completion ${owned===total?"complete":""}">${owned}/${total}</div></div>`;
    wrapper.appendChild(makeStemChips(owned,total));
    return wrapper;
  }
  function openEpOverlay(epTitle,songsInEp){
    const ownedTotal=songsInEp.reduce((a,s)=>a+(s.ownedStems||0),0);
    const maxTotal=songsInEp.reduce((a,s)=>a+(s.totalStems||0),0);
    const pct=maxTotal?Math.round((ownedTotal/maxTotal)*100):0;
    document.getElementById("albumSheetTitle").textContent=epTitle;
    document.getElementById("albumSheetSubtitle").textContent=`${songsInEp.length} Songs`;
    document.getElementById("albumSheetPct").textContent=pct+"%";
    document.getElementById("albumSheetFill").style.width=pct+"%";
    const body=document.getElementById("albumSheetBody");body.innerHTML="";songsInEp.forEach(row=>{body.appendChild(makeSongRow(row.name||"Untitled",row.ownedStems||0,row.totalStems||0));});
    const overlay=document.getElementById("albumOverlay");overlay.classList.add("show");overlay.setAttribute("aria-hidden","false");
  }
  
  function renderEPsGrouped(catalog={}, songs=[], singles=[]) {
    const container = document.getElementById("stems-collections");
    if (!container) return;
    container.innerHTML = "";

    // EP meta index
    const epMeta = new Map();
    asArray(catalog.eps).forEach(ep => epMeta.set(ep.id, ep));

    // Group songs by EP
    const byEp = new Map();
    songs.forEach(row => {
      const key = row.epId || "unknown";
      if (!byEp.has(key)) byEp.set(key, []);
      byEp.get(key).push(row);
    });

    // EP cards
    byEp.forEach((songRows, epId) => {
      const meta = epMeta.get(epId);
      const name = meta?.name || (epId === "unknown" ? "Misc" : "EP");

      const totals = songRows.reduce((acc, r) => {
        acc.owned += r.ownedStems || 0;
        acc.total += r.totalStems || 0;
        return acc;
      }, { owned: 0, total: 0 });
      const pct = totals.total ? Math.round((totals.owned / totals.total) * 100) : 0;

      const card = document.createElement("div");
      card.className = "collection-card";
      card.innerHTML = `
        <div class="collection-header">
          <div class="collection-info">
            <h3>${name}</h3>
            <p>${songRows.length} Songs</p>
          </div>
          <div class="collection-progress">
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <span class="progress-text">${pct}%</span>
          </div>
        </div>
      `;
      card.addEventListener("click", () => openEpOverlay(name, songRows));
      container.appendChild(card);
    });

    // Singles: one card per Single (NOT grouped)
    asArray(singles).forEach(s => {
      const owned = s.ownedStems || 0;
      const total = s.totalStems || 0;
      const pct   = total ? Math.round((owned / total) * 100) : 0;

      const card = document.createElement("div");
      card.className = "collection-card";
      card.innerHTML = `
        <div class="collection-header">
          <div class="collection-info">
            <h3>${s.name || "Single"}</h3>
            <p>${owned}/${total} stems</p>
          </div>
          <div class="collection-progress">
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <span class="progress-text">${pct}%</span>
          </div>
        </div>
      `;
      card.addEventListener("click", () => openEpOverlay(s.name || "Single", [s]));
      container.appendChild(card);
    });
  }

  // Fragments, Albums, Unreleased (greyed if locked)
  function renderFragmentsAll(inv = {}, catalog = {}) {
    const container = document.getElementById("fragments-grid");
    if (!container) return;
    container.innerHTML = "";

    // Collect union of fragment sets from catalog & progress
    const setsByChar = new Map();
    asArray(catalog.fragmentSets).forEach(set => {
      const id = set.characterId || set.id;
      if (!id) return;
      setsByChar.set(id, {
        id,
        name: set.name || "Collection",
        total: set.total || 3,
        image: set.image || ""
      });
    });
    asArray(inv.progress?.fragments).forEach(f => {
      const id = f.characterId || f.id;
      if (!id) return;
      if (!setsByChar.has(id)) {
        setsByChar.set(id, {
          id,
          name: f.name || "Collection",
          total: f.total || 3,
          image: ""
        });
      }
    });

    const list = Array.from(setsByChar.values());
    if (!list.length) {
      container.innerHTML = `<div class="item-card" style="text-align:center;opacity:.6">No fragments found.</div>`;
      return;
    }

    const ownedByChar = new Map((inv.progress?.fragments || []).map(f => [f.characterId || f.id, f.owned || 0]));

    // Card per character (grouped)
    list.forEach(set => {
      const owned = ownedByChar.get(set.id) || 0;
      const total = set.total || 3;
      const pct = Math.min(100, Math.round((owned / total) * 100));

      const card = document.createElement("div");
      card.className = "collection-card";
      card.innerHTML = `
        <div class="collection-header">
          <div class="collection-info">
            <h3>${set.name}</h3>
            <p>${owned}/${total} fragments</p>
          </div>
          <div class="collection-progress">
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
            <span class="progress-text">${pct}%</span>
          </div>
        </div>
      `;

      card.addEventListener("click", () => {
        // build a mini grid of 3 fragments for overlay
        const fragList = document.createElement("div");
        fragList.className = "items-grid";
        for (let i = 1; i <= total; i++) {
          const collected = i <= owned;
          const div = document.createElement("div");
          div.className = "item-card fragment-card" + (collected ? "" : " locked");
          div.innerHTML = `
            <div style="font-weight:600">${set.name} â€“ Fragment ${i}</div>
            <div class="item-completion ${collected ? "complete" : ""}">
              ${collected ? "Owned" : "Locked"}
            </div>
          `;
          fragList.appendChild(div);
        }
        openFragmentOverlay(set.name, owned, total, fragList);
      });

      container.appendChild(card);
    });
  }
      
      function renderAlbumsFromCatalog(inv = {}, catalog = {}) {
        const container = document.getElementById("albums-grid");
        if (!container) return;
        container.innerHTML = "";

        // Union of EPs from catalog & progress
        const byId = new Map();
        asArray(catalog.eps).forEach(ep => {
          if (!ep || !ep.id) return;
          byId.set(ep.id, { id: ep.id, name: ep.name, image: ep.coverImage || ep.image || ep.artUrl || "" });
        });
        asArray(inv.progress?.eps).forEach(ep => {
          if (!ep || !ep.id) return;
          if (!byId.has(ep.id)) byId.set(ep.id, { id: ep.id, name: ep.name, image: "" });
        });

        const epProgress = new Map(asArray(inv.progress?.eps).map(e => [e.id, e]));
        const list = Array.from(byId.values());
        if (!list.length) {
          container.innerHTML = `<div class="item-card" style="text-align:center;opacity:.6">No albums found.</div>`;
          return;
        }

        list.forEach(ep => {
          const prog   = epProgress.get(ep.id);
          const unlocked = !!prog?.complete; // grey if not completed/unlocked
          const card = document.createElement("div");
          card.className = "unreleased-card" + (unlocked ? "" : " locked"); // reuse tile style
          card.innerHTML = `
            ${ep.image ? `<img loading="lazy" src="${ep.image}" alt="" style="width:100%;border-radius:8px;margin-bottom:8px;">` : ""}
            <h3>${ep.name || "Album/EP"}</h3>
          `;
          container.appendChild(card);
        });
      }
      
      function renderUnreleasedFromCatalog(catalog = {}, items = []) {
        const container = document.getElementById("unreleased-grid");
        if (!container) return;
        container.innerHTML = "";

        // Owned: check items with rarity epic/legendary OR kind == 'unreleased'
        const ownedNames = new Set((items || [])
          .filter(it => {
            const r = (it.rarity || "").toLowerCase();
            const k = (it.kind || "").toLowerCase();
            return r === "epic" || r === "legendary" || k === "unreleased";
          })
          .map(it => it.name || it.title || it.itemId)
        );

        // Catalog unreleased
        const list = asArray(catalog.unreleased).map(u => ({
          key: u.id || u.name,
          name: u.name || "Unreleased",
          image: u.image || u.artUrl || "",
          rarity: u.rarity || "Epic",
          audio: u.audio || ""
        }));

        if (!list.length) {
          container.innerHTML = `<div class="item-card" style="text-align:center;opacity:.6">No unreleased items found.</div>`;
          return;
        }

        list.forEach(u => {
          const owned = ownedNames.has(u.name) || ownedNames.has(u.key);
          const card = document.createElement("div");
          card.className = "unreleased-card" + (owned ? "" : " locked");
          card.innerHTML = `
            <h3>${u.name}</h3>
            ${u.audio ? `<audio controls src="${u.audio}" style="width:100%;margin-top:6px"></audio>` : ""}
          `;
          container.appendChild(card);
        });
      }

  /***************************
   * OVERLAY HELPERS
   ***************************/
  document.getElementById("albumCloseBtn")?.addEventListener("click",()=>{const ov=document.getElementById("albumOverlay");ov.classList.remove("show");ov.setAttribute("aria-hidden","true");});
  document.getElementById("fragmentCloseBtn")?.addEventListener("click",()=>{const ov=document.getElementById("fragmentOverlay");ov.classList.remove("show");ov.setAttribute("aria-hidden","true");});

  /***************************
   * INIT
   ***************************/
      (async function init(){
        if (typeof THREE !== "undefined") initViewport();

        let catalog = {};
        let inv = null;

        try{
          const [cRes, iRes] = await Promise.all([
            fetch("/api/catalog",   { credentials: "include" }),
            fetch("/api/inventory", { credentials: "include" })
          ]);

          if (cRes.ok) {
            const raw = await cRes.json();
            catalog = normalizeCatalog(raw);     // âœ… normalize once here
          }
          if (iRes.ok) {
            inv = await iRes.json();
          }
        } catch (e) {
          console.warn("Inventory fetch failed", e);
        }

        // If catalog wasnâ€™t OK above, ensure itâ€™s at least shaped
        if (!catalog || !catalog.eps) {
          catalog = normalizeCatalog(catalog);
        }

        // Debug (safe even if inv is null)
        console.log("CATALOG COUNTS", {
          eps: catalog.eps.length,
          covers: catalog.covers.length,
          fragmentSets: catalog.fragmentSets.length,
          unreleased: catalog.unreleased.length,
          golden: catalog.goldenCharacters.length
        });
        console.log("INV COUNTS", inv && {
          items:      inv.items?.length,
          songs:      inv.progress?.songs?.length,
          eps:        inv.progress?.eps?.length,
          singles:    inv.progress?.singles?.length,
          fragments:  inv.progress?.fragments?.length,
          characters: inv.progress?.characters?.length
        });

        // Empty state
        if (!inv) {
          renderEPsGrouped(catalog, [], []);
          renderCharactersAll({}, catalog);
          renderFragmentsAll({}, catalog);
          renderAlbumsFromCatalog({}, catalog);
          renderUnreleasedFromCatalog(catalog, []);
          return;
        }

        // Real render
        renderEPsGrouped(catalog, inv.progress?.songs || [], inv.progress?.singles || []);
        renderCharactersAll(inv, catalog);
        renderFragmentsAll(inv, catalog);
        renderAlbumsFromCatalog(inv, catalog);
        renderUnreleasedFromCatalog(catalog, inv.items || []);
      })();


  // (Keep your nav/menu/login wiring below here unchanged)
  </script>
  
  <script>
    // Menu tray
    const menuBtn  = document.getElementById('menuBtn');
    const menuTray = document.getElementById('menuTray');
    menuBtn?.addEventListener('click', () => menuTray?.classList.toggle('open'));

    // Desktop tabs
    document.querySelectorAll('.nav-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.target)?.classList.add('active');
      });
    });

    // Mobile bottom nav
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(item.dataset.section)?.classList.add('active');
      });
    });

    // Login modal
    const loginBtn      = document.getElementById('loginBtn');
    const loginModal    = document.getElementById('loginModal');
    const loginCloseBtn = document.getElementById('loginCloseBtn');
    loginBtn?.addEventListener('click', () => loginModal?.classList.add('show'));
    loginCloseBtn?.addEventListener('click', () => loginModal?.classList.remove('show'));

    // Supabase magic link submit
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      if (!email) return;
      try {
        const { error } = await window.supa.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.href }
        });
        if (error) alert(error.message);
        else alert('Check your email for a login link.');
      } catch {
        alert('Login failed.');
      }
    });
  </script>





</body>
</html>
