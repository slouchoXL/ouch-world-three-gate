<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Packs</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
        <script>
        window.__SUPABASE_URL = 'https://srdwkfjterotzjwzoauj.supabase.co';
        window.__SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ';
      </script>
      <script>
        window.supa = window.supabase.createClient(
          window.__SUPABASE_URL,
          window.__SUPABASE_ANON_KEY
        );
      </script>
      <script>
      (async function () {
        try {
          if (window.supa && location.hash && location.hash.includes('access_token')) {
            const params = new URLSearchParams(location.hash.slice(1));
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            const error = params.get('error');
            const error_description = params.get('error_description');

            if (error) {
              alert(`Authentication error: ${error_description || error}`);
              history.replaceState({}, '', location.pathname + location.search);
              return;
            }
            if (access_token && refresh_token) {
              const { error } = await window.supa.auth.setSession({ access_token, refresh_token });
              if (error) alert(`Session error: ${error.message}`); else window.location.reload();
            }
            history.replaceState({}, '', location.pathname + location.search);
          }
        } catch (e) { console.error('[supabase] Magic link processing failed:', e); }
      })();
      </script>


      <title>packs</title>
      <style>
          :root{
              --bg:#000; --card:#000; --text:#eaeaea; --muted:#9aa0a6; --maxw:1200px;
          }
          
          :root {
            --msg-font-size: 11px;
            --msg-line-h: 1.3;
            --msg-vpad: 6px;
            --msg-gap: 6px;
          }
          
          .page {
              height:100%;
              display:grid;
              grid-template-rows:auto 1fr auto;
          }
          main.iframe-shell {
              width:100%;
              height:100dvh;     /* lock to viewport height */
              overflow:hidden;   /* no scroll inside shell */
              background:var(--card);
          }
          main.iframe-shell > iframe {
              display:block;
              width:100%;
              height:100%;       /* fill shell */
              border:0;
              background:#000;
          }
          header, footer {
              display:none;      /* optional: hide header/footer if you want pure fullscreen */
          }
      
            * { margin: 0; padding: 0; box-sizing: border-box; }
            html, body { height: 100%; overflow: hidden; font-family: Arial, sans-serif; background: #000; color: #fff; }
            .container { width: 100vw; position: relative; }
            /*   #scene-container { position: absolute; inset: 0; z-index: 1; }
            #scene-container canvas { display: block; cursor: pointer; }

            /* Top navigation */
            .top-nav {
              position: fixed; top: 0; left: 0; right: 0; z-index: 100;
              display: flex; justify-content: space-between; align-items: center; padding: 20px;
            }
            .menu-button, .login-button {
              width: 30px; height: 30px;
              background: #000;
              border: 1px solid rgba(255, 255, 255, 0.25);
              border-radius: 50%;
              cursor: pointer;
              display: flex; align-items: center; justify-content: center;
              backdrop-filter: none;
              transition: border-color .2s ease, background .2s ease;
            }
            .menu-button:hover, .login-button:hover {
              border-color: rgba(255, 255, 255, 0.45);
              background: #000;
            }
            .menu-dots { display: flex; gap: 4px; }
            .dot { width: 3px; height: 3px; background: #fff; border-radius: 50%; }
            .user-icon { width: 16px; height: 16px; color: #fff; }
            .user-icon svg { width: 100%; height: 100%; fill: currentColor; }

            /* Menu tray */
            .menu-tray {
              position: fixed; top: 60px; left: 20px; width: 130px;
              background: rgba(255, 255, 255,0.2); backdrop-filter: blur(20px);
              border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; z-index: 200;
              transform: translateY(-20px); opacity: 0; visibility: hidden; transition: all .3s ease; padding: 10px 0;
            }
            .menu-tray.open { transform: translateY(0); opacity: 1; visibility: visible; }

            /* Menu items with pill hover */
            .menu-item {
              position: relative;
              display: block;
              width: 100%;
              padding: 6px 15px;
              color: #fff;
              text-decoration: none;
              font-size: 14px;
              font-weight: 300;
              cursor: pointer;
              background: none;
              border: 0;
            }

            .menu-item::before {
              content: "";
              position: absolute;
              inset: 1px;
              left: 8px;
              right: 8px;
              border-radius: 8px;
              background: rgba(255,255,255,0.12);
              opacity: 0;
              transform: scaleY(0.96);
              transition: opacity .15s ease, transform .2s ease;
              pointer-events: none;
            }

            .menu-item:hover::before,
            .menu-item:focus-visible::before {
              opacity: 1;
              transform: scaleY(1);
            }

            .menu-item, .menu-item * {
              position: relative;
              z-index: 1;
            }

            .menu-item .menu-pill {
              background: transparent !important;
              padding: 0 !important;
              border-radius: 0 !important;
            }

            /* Modal overlay + dialog */
            .modal-overlay {
              position: fixed;
              inset: 0;
              background: rgba(0,0,0,0.7);
              z-index: 300;
              display: none;
              align-items: center;
              justify-content: center;
              backdrop-filter: blur(5px);
            }
            .modal-overlay.show {
              display: flex;
            }
            .login-modal {
              background: rgba(0,0,0,0.9);
              backdrop-filter: blur(20px);
              border: 1px solid rgba(255,255,255,0.2);
              border-radius: 16px;
              padding: 15px;
              width: 90%;
              max-width: 400px;
              position: relative;
              color: #fff;
            }
          
          input, textarea, select {
               font-size: 16px;
             }
          /* Tell browsers these elements trigger only taps/clicks (no zooming gestures) */
          button, a, .menu-button, .login-button, .chat-toggle, .send-button, .arrow-btn, .character-confirm {
            touch-action: manipulation;
          }

            .modal-close {
              position: absolute;
              top: 8px; right: 15px;
              background: none; border: none;
              color: rgba(255,255,255,0.6);
              font-size: 24px; cursor: pointer;
              width: 30px; height: 30px; border-radius: 50%;
              display: flex; align-items: center; justify-content: center;
              transition: all .2s ease;
            }
            .modal-close:hover { color: #fff; background: none; }
            .modal-title { font-size: 24px; font-weight: 300; margin-bottom: 20px; text-align: center; }
            .modal-tabs { display: flex; gap: 20px; margin-bottom: 20px; justify-content: center; }
            .modal-tab { background: none; border: none; color: rgba(255,255,255,0.6); font-size: 16px; padding: 8px 0; cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s ease; }
            .modal-tab.active { color: #fff; }
            .form-group { margin-bottom: 12px; }
            .form-input {
              width: 100%; background: rgba(255,255,255,0.1);
              border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
              padding: 12px 15px; color: #fff; font-size: 16px; outline: none;
            }
            .form-input::placeholder { color: rgba(255,255,255,0.5); }
            .form-button {
              width: 100%; background: rgba(255,255,255,0.92); color: #000;
              border: none; border-radius: 8px; padding: 12px; font-size: 14px; font-weight: 500; cursor: pointer;
            }

       

            /* Character selector */
            :root {
              --title-width: 240px;
              --arrow-gap: 6px;
              --arrow-size-w: 34px;
              --arrow-size-h: 30px;
              --modal-padding-x: 10px;
            }
            .character-controls { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; display: none; }
            .character-controls.show { display: block; }
            .character-info {
              background: rgba(0,0,0,0.8);
              backdrop-filter: blur(20px);
              border: 1px solid rgba(255,255,255,0.2);
              border-radius: 10px;
              padding: 8px var(--modal-padding-x);
              width: calc(var(--title-width) + 2 * (var(--arrow-size-w) + var(--arrow-gap)) + 2 * var(--modal-padding-x));
            }
            .character-header {
              display: grid;
              grid-template-columns: var(--arrow-size-w) var(--title-width) var(--arrow-size-w);
              align-items: center; justify-items: center; column-gap: var(--arrow-gap);
            }
            .character-name { font-size: 14px; font-weight: 600; text-align: center; white-space: nowrap; width: var(--title-width); overflow: hidden; text-overflow: ellipsis; line-height: 1; }
            .arrow-btn {
              width: var(--arrow-size-w); height: var(--arrow-size-h);
              border: none; background: none; color: #fff; cursor: pointer;
              display: flex; align-items: center; justify-content: center;
              font-size: 16px; line-height: 1; transition: opacity .2s ease;
            }
            .arrow-btn:hover { opacity: 0.8; }
            .character-actions { display: flex; justify-content: center; margin-top: 8px; }
            .character-confirm { background: rgba(255,255,255,0.92); color: #000; border: none; border-radius: 8px; padding: 6px 12px; font-size: 16px; cursor: pointer; transition: background .2s ease; }
            .character-confirm:hover { background: #fff; }

            @media (max-width: 420px) {
              :root { --arrow-size-w: 30px; --arrow-size-h: 28px; --modal-padding-x: 8px; }
            }

            @media (prefers-reduced-motion: reduce) {
              .chatbot-container { transition: none; transform: translateX(-50%); }
              .chatbot-container.open { transition: none; }
            }
          </style>
        </head>
        <body>

        <div class="container">
          <div id="scene-container"></div>

          <!-- Top Navigation -->
          <div class="top-nav">
            <button class="menu-button" onclick="toggleMenu()">
              <div class="menu-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            </button>
            <button class="login-button" onclick="handleLogin()">
              <div class="user-icon">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
              </div>
            </button>
          </div>

          <!-- Menu Tray -->
          <div class="menu-tray" id="menuTray">
              <a href="/landing-page/" class="menu-item"><span class="menu-pill">Home</span></a>
              <a href="#" class="menu-item"><span class="menu-pill">Label</span></a>
              <a href="#" class="menu-item"><span class="menu-pill">Merch</span></a>
              <a href="/packs/" class="menu-item"><span class="menu-pill">Packs</span></a>
              <a href="#" class="menu-item"><span class="menu-pill">Inventory</span></a>
          </div>

          <!-- Character Selector -->
          <div class="character-controls" id="characterControls">
            <div class="character-info">
              <div class="character-header">
                <button class="arrow-btn" id="prevArrow" title="Previous">‹</button>
                <div class="character-name" id="characterName">Default Character</div>
                <button class="arrow-btn" id="nextArrow" title="Next">›</button>
              </div>
              <div class="character-actions">
                <button class="character-confirm" onclick="window.confirmCharacter()">Select</button>
              </div>
            </div>
          </div>

          <!-- Login Modal -->
          <div class="modal-overlay" id="loginModal">
            <div class="login-modal">
              <button class="modal-close" onclick="closeLoginModal()">&times;</button>
              <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('login')">Account</button>
              </div>
              <div id="loginForm">
                <div class="form-group">
                  <input type="email" id="loginEmail" class="form-input" placeholder="Email" required>
                </div>
                <button id="loginSubmit" class="form-button">Create / Login</button>
              </div>
              <div id="signupForm" style="display:none;">
                <div class="form-group"><input type="text" class="form-input" placeholder="Username"></div>
                <div class="form-group"><input type="email" class="form-input" placeholder="Email"></div>
                <button class="form-button">Sign Up</button>
              </div>
            </div>
          </div>

         
    
      </style>
      
      <!-- Add this script to your /packs page (the parent page with the iframe) -->
      <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
      <script>
      // Create Supabase client on parent page
      window.supa = window.supabase.createClient(
        'https://srdwkfjterotzjwzoauj.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNyZHdrZmp0ZXJvdHpqd3pvYXVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4NjU5NTksImV4cCI6MjA3MTQ0MTk1OX0.c0mJbQsfJMmqLiulXdZfWscd7J507buzRXkd700ymAQ'
      );

      // Handle magic link tokens on parent page
      (async function () {
        try {
          if (location.hash && location.hash.includes('access_token')) {
            console.log('[Parent] Processing magic link tokens...');
            
            const params = new URLSearchParams(location.hash.slice(1));
            const access_token = params.get('access_token');
            const refresh_token = params.get('refresh_token');
            const error = params.get('error');

            if (error) {
              console.error('[Parent] Auth error:', error);
              alert(`Authentication error: ${params.get('error_description') || error}`);
            } else if (access_token && refresh_token) {
              console.log('[Parent] Setting session from magic link...');
              
              const { data, error } = await window.supa.auth.setSession({
                access_token,
                refresh_token
              });
              
              if (error) {
                console.error('[Parent] Session error:', error);
                alert(`Session error: ${error.message}`);
              } else {
                console.log('[Parent] ✅ Authentication successful!');
                
                // Find the iframe and tell it to refresh
                const iframe = document.querySelector('iframe');
                if (iframe) {
                  console.log('[Parent] Notifying iframe of successful auth...');
                  // The iframe will detect the auth state change automatically
                  iframe.contentWindow.postMessage({ type: 'auth-success' }, '*');
                }
              }
            }
            
            // Clean the URL hash (remove tokens from address bar)
            history.replaceState({}, '', location.pathname + location.search);
          }
        } catch (e) {
          console.error('[Parent] Magic link processing failed:', e);
        }
      })();
      </script>
      
      <script>
      
      // ===== UI: Menu & Login =====
      function toggleMenu() {
          document.getElementById('menuTray').classList.toggle('open');
      }
      function handleLogin() {
          document.getElementById('loginModal').classList.add('show');
      }
      function closeLoginModal() {
          document.getElementById('loginModal').classList.remove('show');
      }
      function switchTab(tab) {
          const tabs = document.querySelectorAll('.modal-tab');
          const loginForm = document.getElementById('loginForm');
          const signupForm = document.getElementById('signupForm');
          tabs.forEach(t => t.classList.remove('active'));
          if (tab === 'login') {
              tabs[0].classList.add('active');
              loginForm.style.display = 'block';
              signupForm.style.display = 'none';
          } else {
              tabs[1].classList.add('active');
              loginForm.style.display = 'none';
              signupForm.style.display = 'block';
          }
      }

      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
          const tray = document.getElementById('menuTray');
          const btn = document.querySelector('.menu-button');
          if (tray && !tray.contains(e.target) && !btn.contains(e.target)) {
              tray.classList.remove('open');
          }
      });

      // Close modal when clicking outside
      document.getElementById('loginModal').addEventListener('click', function(e) {
          if (e.target === this) closeLoginModal();
      });

      // Chatbot functions
      function handleKeyPress(e) {
          if (e.key === 'Enter') sendMessage();
      }
      
      function sendMessage() {
          const input = document.getElementById('chatInput');
          const text = input.value.trim();
          if (!text) return;
          addMessage(text, 'user');
          input.value = '';
          setTimeout(() => addMessage(generateBotResponse(text), 'bot'), 500);
      }
      
      function addMessage(text, sender) {
          const box = document.getElementById('chatMessages');
          if (!box) return;
          const div = document.createElement('div');
          div.className = `message ${sender}`;
          div.textContent = text;
          box.appendChild(div);
          box.scrollTop = box.scrollHeight;
      }
      
      function generateBotResponse(msg) {
          const m = msg.toLowerCase();
          if (m.includes('hello')) return "Hello! Welcome to the character showcase. How can I help you today?";
          if (m.includes('hi')) return "Hi there! I'm here to help you navigate the site. What would you like to know?";
          if (m.includes('help')) return "I can help you with information about the character, navigation, or features of this site.";
          if (m.includes('character')) return "This is a 3D character model you can click to open the selector.";
          if (m.includes('website')) return "This website showcases 3D character models with interactive features.";
          if (m.includes('menu')) return "Click the three dots in the top-left to open the menu.";
          if (m.includes('login')) return "Click the user icon in the top-right to open login.";
          return "Thanks for your message! Ask about the character, website features, or navigation.";
      }

      // Chat toggle functionality
      const chatEl = document.querySelector('.chatbot-container');
      const chatToggleBtn = document.getElementById('chatToggle');

      function setChatOpen(open) {
          chatEl.classList.toggle('open', open);
          chatToggleBtn.setAttribute('aria-expanded', String(open));
      }

      // Start closed by default
      setChatOpen(false);

      chatToggleBtn.addEventListener('click', () => {
          setChatOpen(!chatEl.classList.contains('open'));
      });
          
          // Wire up the login modal form
          document.addEventListener('DOMContentLoaded', () => {
            const formButton = document.querySelector('#loginForm .form-button');
            const emailInput = document.querySelector('#loginForm .form-input');
            
            formButton.addEventListener('click', async () => {
              const email = emailInput.value.trim();
              if (!email) return alert('Please enter your email');
              
              formButton.disabled = true;
              formButton.textContent = 'Sending...';
              
              try {
                const { error } = await window.supa.auth.signInWithOtp({
                  email,
                  options: { emailRedirectTo: window.location.href }
                });
                
                if (error) throw error;
                
                alert('Check your email for the magic link!');
                closeLoginModal();
              } catch (error) {
                alert('Error: ' + error.message);
              } finally {
                formButton.disabled = false;
                formButton.textContent = 'Create / Login';
              }
            });
            
            // Listen for iframe requesting login
            window.addEventListener('message', (event) => {
              if (event.data?.type === 'show_login_modal') {
                handleLogin();
              }
            });
          });

      </script>
</head>
<body>
  <div class="page">
    <header></header>

    <main class="iframe-shell">
      <iframe
        id="packsFrame"
        src="../widget/index.html"
        loading="eager"
        scrolling="no"
        referrerpolicy="no-referrer-when-downgrade"
        allow="clipboard-read; clipboard-write">
      </iframe>
    </main>

  </div>
  
  <script>
  (function () {
    const emailInput = document.getElementById('loginEmail');   // your modal email input
    const loginBtn   = document.getElementById('loginSubmit');  // your modal button

    if (!emailInput || !loginBtn) return; // modal not on this page

    function magicRedirect() {
      const isInIframe = window !== window.top;
      // Same logic as your working page: always return to /packs
      return isInIframe
        ? 'https://ouchworld.netlify.app/packs'
        : `${location.origin}/packs`;
    }

    loginBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = (emailInput.value || '').trim();
      if (!email) return alert('Enter your email');
      if (!window.supa?.auth) return alert('Auth not initialized');

      loginBtn.disabled = true; const old = loginBtn.textContent; loginBtn.textContent = 'Sending…';
      const { error } = await window.supa.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: magicRedirect() }
      });
      loginBtn.disabled = false; loginBtn.textContent = old;

      if (error) alert(error.message);
      else alert('Check your email for the magic link!');
    });
  })();
  </script>
  <script>
    // Prevent double-tap zoom
    (function () {
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (e) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault(); // cancel the second tap
        }
        lastTouchEnd = now;
      }, { passive: false });
    })();
  </script>
</body>
</html>
